üîù Retour au [Sommaire](/SOMMAIRE.md)

# 14.2.2 Versioning et SONAME

## Introduction

Lorsque vous cr√©ez des biblioth√®ques partag√©es (`.so`), un probl√®me majeur se pose : **comment g√©rer les mises √† jour ?** Si vous modifiez votre biblioth√®que, comment s'assurer que les programmes qui l'utilisent continuent de fonctionner ?

C'est l√† qu'interviennent le **versioning** et le **SONAME** (Shared Object Name). Ces m√©canismes permettent de g√©rer plusieurs versions d'une m√™me biblioth√®que sur un syst√®me et d'assurer la compatibilit√© entre diff√©rentes versions.

Dans cette section, nous allons comprendre pourquoi et comment versionner vos biblioth√®ques partag√©es.

---

## Le probl√®me de la compatibilit√©

### Sc√©nario sans versioning

Imaginons que vous distribuez une biblioth√®que `libmath.so` :

**Version 1.0 :**
```c
// libmath.so version 1.0
int addition(int a, int b) {
    return a + b;
}
```

Des programmes l'utilisent :
```c
// programme.c
#include "math.h"
int main() {
    int result = addition(5, 3);  // OK
}
```

**Version 2.0 - Modification incompatible :**
```c
// libmath.so version 2.0
double addition(double a, double b) {  // Signature chang√©e !
    return a + b;
}
```

**Probl√®me :** Si vous remplacez `libmath.so` par la version 2.0, tous les programmes compil√©s avec la version 1.0 vont **planter** car ils s'attendent √† une fonction `int addition(int, int)` et non `double addition(double, double)`.

### La "DLL Hell" ou "Dependency Hell"

```
Syst√®me sans versioning :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  /usr/lib/libmath.so               ‚îÇ
‚îÇ  (Une seule version possible)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñ≤               ‚ñ≤
        ‚îÇ               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Programme A‚îÇ    ‚îÇ Programme B‚îÇ
‚îÇ (compile   ‚îÇ    ‚îÇ (compile   ‚îÇ
‚îÇ  v1.0)     ‚îÇ    ‚îÇ  v2.0)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       üí• Conflit !
```

**Avec versioning :**
```
Syst√®me avec versioning :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  /usr/lib/libmath.so.1.0           ‚îÇ
‚îÇ  /usr/lib/libmath.so.2.0           ‚îÇ
‚îÇ  (Plusieurs versions coexistent)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñ≤               ‚ñ≤
        ‚îÇ               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Programme A‚îÇ    ‚îÇ Programme B‚îÇ
‚îÇ ‚Üí v1.0     ‚îÇ    ‚îÇ ‚Üí v2.0     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚úì Les deux fonctionnent !
```

---

## Les trois types de version

Une biblioth√®que partag√©e peut avoir **trois niveaux de version** :

### 1. Version compl√®te (Real name)

Le **nom r√©el** du fichier avec la version compl√®te :

```
libmath.so.1.2.3
‚îÇ      ‚îÇ  ‚îÇ ‚îÇ ‚îÇ
‚îÇ      ‚îÇ  ‚îÇ ‚îÇ ‚îî‚îÄ Patch version (corrections de bugs)
‚îÇ      ‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ Minor version (nouvelles fonctionnalit√©s compatibles)
‚îÇ      ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Major version (changements incompatibles)
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ "Shared Object"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Pr√©fixe "lib"
```

**Format :** `libNOM.so.MAJOR.MINOR.PATCH`

### 2. SONAME (Shared Object Name)

Le **nom de compatibilit√©** qui contient uniquement la version majeure :

```
libmath.so.1
‚îÇ      ‚îÇ  ‚îÇ
‚îÇ      ‚îÇ  ‚îî‚îÄ Major version seulement
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ "Shared Object"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Pr√©fixe "lib"
```

**Format :** `libNOM.so.MAJOR`

**R√¥le :** Indique quelles versions sont **binaire-compatibles**.

### 3. Linker name

Le **nom de d√©veloppement** sans num√©ro de version :

```
libmath.so
‚îÇ      ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ "Shared Object"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Pr√©fixe "lib"
```

**Format :** `libNOM.so`

**R√¥le :** Utilis√© lors de la **compilation** avec `-lmath`.

---

## La hi√©rarchie des liens symboliques

### Sch√©ma complet

```
Fichier r√©el (Real name) :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ libmath.so.1.2.3     ‚îÇ ‚Üê Fichier physique (binaire)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤
         ‚îÇ (lien symbolique)
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ libmath.so.1         ‚îÇ ‚Üê SONAME (compatibilit√© runtime)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚ñ≤
         ‚îÇ (lien symbolique)
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ libmath.so           ‚îÇ ‚Üê Linker name (compilation)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Explication de la cha√Æne

1. **`libmath.so.1.2.3`** (fichier r√©el)
   - C'est le fichier binaire r√©el
   - Contient le code machine de la biblioth√®que
   - Version compl√®te : 1.2.3

2. **`libmath.so.1`** ‚Üí pointe vers `libmath.so.1.2.3`
   - SONAME (lien symbolique)
   - Version majeure seulement
   - Utilis√© par les programmes **√† l'ex√©cution**

3. **`libmath.so`** ‚Üí pointe vers `libmath.so.1`
   - Linker name (lien symbolique)
   - Aucun num√©ro de version
   - Utilis√© par le compilateur **√† la compilation**

### V√©rification sur le syst√®me

```bash
ls -l /usr/lib/x86_64-linux-gnu/libpthread.so*
```

Sortie typique :
```
lrwxrwxrwx libpthread.so -> libpthread.so.0  
lrwxrwxrwx libpthread.so.0 -> libpthread-2.31.so  
-rwxr-xr-x libpthread-2.31.so
```

**Lecture :**
- `libpthread.so` (linker name) pointe vers `libpthread.so.0`
- `libpthread.so.0` (SONAME) pointe vers `libpthread-2.31.so`
- `libpthread-2.31.so` est le fichier r√©el

---

## Cr√©ation d'une biblioth√®que versionn√©e

### Workflow complet

**√âtape 1 : Compiler avec `-fPIC`**

```bash
gcc -fPIC -c math_utils.c -o math_utils.o
```

**√âtape 2 : Cr√©er la biblioth√®que avec SONAME**

```bash
gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.2.3 math_utils.o
```

**D√©composition de la commande :**

| Partie | Signification |
|--------|---------------|
| `gcc -shared` | Cr√©e une biblioth√®que partag√©e |
| `-Wl,-soname,libmath.so.1` | D√©finit le SONAME dans la biblioth√®que |
| `-o libmath.so.1.2.3` | Nom du fichier de sortie (real name) |
| `math_utils.o` | Fichiers objets √† inclure |

**Explication de `-Wl,-soname` :**
- `-Wl,` : Passe l'option suivante au linker (`ld`)
- `-soname,libmath.so.1` : D√©finit le SONAME comme `libmath.so.1`

**√âtape 3 : Cr√©er les liens symboliques**

```bash
# Cr√©er le lien SONAME
ln -s libmath.so.1.2.3 libmath.so.1

# Cr√©er le lien linker name
ln -s libmath.so.1 libmath.so
```

**R√©sultat :**
```
libmath.so ‚Üí libmath.so.1 ‚Üí libmath.so.1.2.3 (fichier r√©el)
```

### V√©rification

**V√©rifier les liens :**
```bash
ls -l libmath.so*
```

Sortie :
```
lrwxrwxrwx libmath.so -> libmath.so.1  
lrwxrwxrwx libmath.so.1 -> libmath.so.1.2.3  
-rwxr-xr-x libmath.so.1.2.3
```

**V√©rifier le SONAME int√©gr√© :**
```bash
readelf -d libmath.so.1.2.3 | grep SONAME
```

Sortie :
```
 0x000000000000000e (SONAME)             Library soname: [libmath.so.1]
```

‚úÖ Le SONAME est bien int√©gr√© dans le fichier binaire !

---

## Sch√©ma de versioning s√©mantique

### Format X.Y.Z

```
Version:  1  .  2  .  3
          ‚îÇ     ‚îÇ     ‚îÇ
          ‚îÇ     ‚îÇ     ‚îî‚îÄ PATCH : Corrections de bugs
          ‚îÇ     ‚îÇ         - R√©tro-compatible
          ‚îÇ     ‚îÇ         - Pas de nouvelles fonctionnalit√©s
          ‚îÇ     ‚îÇ         - Exemple : Correction de fuite m√©moire
          ‚îÇ     ‚îÇ
          ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MINOR : Nouvelles fonctionnalit√©s
          ‚îÇ                - R√©tro-compatible
          ‚îÇ                - Ajout de nouvelles fonctions
          ‚îÇ                - Exemple : Ajouter multiplication()
          ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MAJOR : Changements incompatibles
                          - ROMPT la compatibilit√©
                          - Modification de signatures
                          - Suppression de fonctions
                          - Exemple : Changer int ‚Üí double
```

### R√®gles de versioning

| Changement | Version | SONAME change ? | Exemple |
|------------|---------|-----------------|---------|
| Correction bug | 1.2.3 ‚Üí 1.2.4 | ‚ùå Non | Corriger un calcul |
| Nouvelle fonction | 1.2.4 ‚Üí 1.3.0 | ‚ùå Non | Ajouter `soustraction()` |
| Signature modifi√©e | 1.3.0 ‚Üí 2.0.0 | ‚úÖ Oui | `int` ‚Üí `double` |
| Fonction supprim√©e | 2.0.0 ‚Üí 3.0.0 | ‚úÖ Oui | Retirer `deprecated_func()` |

### Exemple de sc√©nario

**Version 1.0.0 :**
```c
// libmath.so.1.0.0 (SONAME: libmath.so.1)
int addition(int a, int b);  
int multiplication(int a, int b);  
```

**Version 1.1.0 :** Ajout de fonction
```c
// libmath.so.1.1.0 (SONAME: libmath.so.1 inchang√©)
int addition(int a, int b);  
int multiplication(int a, int b);  
int soustraction(int a, int b);  // NOUVEAU  
```
‚úÖ Compatible avec programmes compil√©s pour 1.0.0

**Version 1.1.1 :** Correction de bug
```c
// libmath.so.1.1.1 (SONAME: libmath.so.1 inchang√©)
int addition(int a, int b);  // Bug corrig√©  
int multiplication(int a, int b);  
int soustraction(int a, int b);  
```
‚úÖ Compatible avec programmes compil√©s pour 1.0.0 et 1.1.0

**Version 2.0.0 :** Changement incompatible
```c
// libmath.so.2.0.0 (SONAME: libmath.so.2 CHANG√â !)
double addition(double a, double b);  // Type chang√© !  
double multiplication(double a, double b);  
double soustraction(double a, double b);  
```
‚ùå **Incompatible** avec programmes compil√©s pour 1.x.x

---

## Comment les programmes utilisent le SONAME

### Lors de la compilation

**Commande de compilation :**
```bash
gcc main.c -L. -lmath -o programme
```

**Ce qui se passe :**

1. Le compilateur cherche `libmath.so` (linker name)
2. Il trouve le lien symbolique qui pointe vers `libmath.so.1`
3. Il lit le **SONAME** depuis `libmath.so.1.x.x`
4. Il **enregistre le SONAME** dans l'ex√©cutable

**V√©rification :**
```bash
readelf -d programme | grep NEEDED
```

Sortie :
```
 0x0000000000000001 (NEEDED)             Shared library: [libmath.so.1]
```

Notez que c'est **`libmath.so.1`** (le SONAME) et non `libmath.so.1.2.3` !

### Lors de l'ex√©cution

**Lancement du programme :**
```bash
./programme
```

**Ce qui se passe :**

1. Le loader dynamique (`ld.so`) lit les d√©pendances
2. Il cherche **`libmath.so.1`** (le SONAME)
3. Il charge le fichier point√© par ce lien symbolique
4. Peu importe que ce soit `libmath.so.1.2.3` ou `libmath.so.1.9.5`

**Tant que le SONAME est le m√™me (version majeure), √ßa fonctionne !**

---

## Mise √† jour d'une biblioth√®que

### Sc√©nario : Mise √† jour mineure

Vous avez cr√©√© `libmath.so.1.2.3` et voulez la mettre √† jour vers `1.3.0`.

**Avant :**
```
libmath.so ‚Üí libmath.so.1 ‚Üí libmath.so.1.2.3
```

**√âtape 1 : Compiler la nouvelle version**
```bash
gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.3.0 math_utils.o
```

**√âtape 2 : Mettre √† jour le lien SONAME**
```bash
ln -sf libmath.so.1.3.0 libmath.so.1
```

**√âtape 3 : Mettre √† jour le linker name**
```bash
ln -sf libmath.so.1 libmath.so
```

**Apr√®s :**
```
libmath.so ‚Üí libmath.so.1 ‚Üí libmath.so.1.3.0
                            (ancien: libmath.so.1.2.3 toujours pr√©sent)
```

**R√©sultat :**
- Les programmes **existants** continuent de fonctionner (ils utilisent `libmath.so.1`)
- Les **nouveaux programmes** seront compil√©s avec la version 1.3.0
- Vous pouvez **supprimer** `libmath.so.1.2.3` si plus utilis√©

### Sc√©nario : Changement de version majeure

Passage de version 1.x.x √† 2.0.0 (incompatible).

**Avant :**
```
libmath.so ‚Üí libmath.so.1 ‚Üí libmath.so.1.3.0
```

**√âtape 1 : Compiler la nouvelle version**
```bash
gcc -shared -Wl,-soname,libmath.so.2 -o libmath.so.2.0.0 math_utils.o
```

**√âtape 2 : Cr√©er de nouveaux liens pour v2**
```bash
ln -s libmath.so.2.0.0 libmath.so.2  
ln -sf libmath.so.2 libmath.so  # Pointer vers la v2 par d√©faut  
```

**Apr√®s :**
```
libmath.so ‚Üí libmath.so.2 ‚Üí libmath.so.2.0.0  
libmath.so.1 ‚Üí libmath.so.1.3.0  (toujours pr√©sent)  
```

**R√©sultat :**
- ‚úÖ **Anciens programmes** continuent avec `libmath.so.1`
- ‚úÖ **Nouveaux programmes** utilisent `libmath.so.2`
- ‚úÖ Les deux versions **coexistent** sur le syst√®me

---

## Outils de gestion de versioning

### `ldconfig` : Gestionnaire de cache

**R√¥le :** `ldconfig` met √† jour le cache des biblioth√®ques partag√©es et cr√©e les liens SONAME automatiquement.

**Utilisation typique :**

```bash
# Installer votre biblioth√®que
sudo cp libmath.so.1.2.3 /usr/local/lib/

# Cr√©er le lien SONAME
sudo ln -s /usr/local/lib/libmath.so.1.2.3 /usr/local/lib/libmath.so.1

# Mettre √† jour le cache
sudo ldconfig
```

**Ce que fait `ldconfig` :**
1. Scanne les r√©pertoires `/lib`, `/usr/lib`, `/usr/local/lib`, etc.
2. Lit le SONAME de chaque `.so`
3. Cr√©e automatiquement les liens symboliques SONAME
4. Met √† jour le cache `/etc/ld.so.cache`

**V√©rifier le cache :**
```bash
ldconfig -p | grep libmath
```

Sortie :
```
libmath.so.1 (libc6,x86-64) => /usr/local/lib/libmath.so.1.2.3
```

### Visualiser les d√©pendances avec `ldd`

```bash
ldd programme
```

Sortie exemple :
```
linux-vdso.so.1 (0x00007ffd123ab000)  
libmath.so.1 => /usr/local/lib/libmath.so.1.2.3 (0x00007f8e12345000)  
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8e12100000)  
/lib64/ld-linux-x86-64.so.2 (0x00007f8e12500000)
```

Vous voyez :
- Le programme cherche `libmath.so.1` (SONAME)
- Il est r√©solu vers `/usr/local/lib/libmath.so.1.2.3`

---

## Exemple complet de cycle de vie

### D√©veloppement initial (v1.0.0)

**Code :**
```c
// math_utils.c
#include "math_utils.h"

int addition(int a, int b) {
    return a + b;
}
```

**Compilation :**
```bash
gcc -fPIC -c math_utils.c -o math_utils.o  
gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.0.0 math_utils.o  
ln -s libmath.so.1.0.0 libmath.so.1  
ln -s libmath.so.1 libmath.so  
```

**Installation :**
```bash
sudo cp libmath.so.1.0.0 /usr/local/lib/  
sudo ln -s /usr/local/lib/libmath.so.1.0.0 /usr/local/lib/libmath.so.1  
sudo ln -s /usr/local/lib/libmath.so.1 /usr/local/lib/libmath.so  
sudo ldconfig  
```

**Utilisation :**
```c
// programme_v1.c
#include <stdio.h>
#include "math_utils.h"

int main() {
    printf("5 + 3 = %d\n", addition(5, 3));
    return 0;
}
```

```bash
gcc programme_v1.c -lmath -o programme_v1
./programme_v1
```

### Mise √† jour mineure (v1.1.0)

**Nouveau code (ajout de fonction) :**
```c
// math_utils.c
#include "math_utils.h"

int addition(int a, int b) {
    return a + b;
}

// NOUVELLE FONCTION
int multiplication(int a, int b) {
    return a * b;
}
```

**Compilation :**
```bash
gcc -fPIC -c math_utils.c -o math_utils.o  
gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.1.0 math_utils.o  
```

**Installation (mise √† jour) :**
```bash
sudo cp libmath.so.1.1.0 /usr/local/lib/  
sudo ln -sf /usr/local/lib/libmath.so.1.1.0 /usr/local/lib/libmath.so.1  
sudo ldconfig  
```

**R√©sultat :**
- ‚úÖ `programme_v1` fonctionne toujours (utilise `addition()`)
- ‚úÖ Les nouveaux programmes peuvent utiliser `multiplication()`

### Changement majeur (v2.0.0)

**Nouveau code (incompatible) :**
```c
// math_utils.c
#include "math_utils.h"

// Type chang√© : int ‚Üí double
double addition(double a, double b) {
    return a + b;
}

double multiplication(double a, double b) {
    return a * b;
}
```

**Compilation :**
```bash
gcc -fPIC -c math_utils.c -o math_utils.o  
gcc -shared -Wl,-soname,libmath.so.2 -o libmath.so.2.0.0 math_utils.o  
```

**Installation (nouvelle version majeure) :**
```bash
sudo cp libmath.so.2.0.0 /usr/local/lib/  
sudo ln -s /usr/local/lib/libmath.so.2.0.0 /usr/local/lib/libmath.so.2  
sudo ln -sf /usr/local/lib/libmath.so.2 /usr/local/lib/libmath.so  
sudo ldconfig  
```

**R√©sultat :**
- ‚úÖ `programme_v1` fonctionne toujours (utilise `libmath.so.1`)
- ‚úÖ Nouveaux programmes compil√©s utilisent `libmath.so.2`
- ‚úÖ Les deux versions **coexistent** pacifiquement

---

## Makefile avec versioning automatique

### Makefile complet

```makefile
# Variables de version
MAJOR = 1  
MINOR = 2  
PATCH = 3  
VERSION = $(MAJOR).$(MINOR).$(PATCH)  

# Noms de fichiers
LIBRARY_NAME = libmath  
SONAME = $(LIBRARY_NAME).so.$(MAJOR)  
REAL_NAME = $(LIBRARY_NAME).so.$(VERSION)  
LINKER_NAME = $(LIBRARY_NAME).so  

# Compilateur et flags
CC = gcc  
CFLAGS = -fPIC -Wall -Wextra -O2  
LDFLAGS = -shared -Wl,-soname,$(SONAME)  

# Fichiers sources
SRC = math_utils.c  
OBJ = $(SRC:.c=.o)  

# R√®gle par d√©faut
all: $(REAL_NAME) links

# Cr√©er la biblioth√®que avec SONAME
$(REAL_NAME): $(OBJ)
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "‚úì Biblioth√®que cr√©√©e : $(REAL_NAME)"
	@echo "  SONAME int√©gr√© : $(SONAME)"

# Compiler les objets
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# Cr√©er les liens symboliques
links: $(REAL_NAME)
	ln -sf $(REAL_NAME) $(SONAME)
	ln -sf $(SONAME) $(LINKER_NAME)
	@echo "‚úì Liens cr√©√©s :"
	@echo "  $(LINKER_NAME) ‚Üí $(SONAME) ‚Üí $(REAL_NAME)"

# Installation syst√®me
install: all
	sudo cp $(REAL_NAME) /usr/local/lib/
	sudo ln -sf /usr/local/lib/$(REAL_NAME) /usr/local/lib/$(SONAME)
	sudo ln -sf /usr/local/lib/$(SONAME) /usr/local/lib/$(LINKER_NAME)
	sudo ldconfig
	@echo "‚úì Installation termin√©e"

# D√©sinstallation
uninstall:
	sudo rm -f /usr/local/lib/$(REAL_NAME)
	sudo rm -f /usr/local/lib/$(SONAME)
	sudo rm -f /usr/local/lib/$(LINKER_NAME)
	sudo ldconfig
	@echo "‚úì D√©sinstallation termin√©e"

# Informations sur la biblioth√®que
info:
	@echo "=== Informations sur la biblioth√®que ==="
	@echo "Nom complet : $(REAL_NAME)"
	@echo "SONAME      : $(SONAME)"
	@echo "Linker name : $(LINKER_NAME)"
	@echo ""
	@echo "=== V√©rification SONAME ==="
	@readelf -d $(REAL_NAME) | grep SONAME || echo "Aucun SONAME"
	@echo ""
	@echo "=== Liens symboliques ==="
	@ls -l $(LIBRARY_NAME).so* 2>/dev/null || echo "Aucun lien cr√©√©"

# Nettoyage
clean:
	rm -f $(OBJ) $(REAL_NAME) $(SONAME) $(LINKER_NAME)
	@echo "‚úì Nettoyage effectu√©"

.PHONY: all links install uninstall info clean
```

### Utilisation du Makefile

```bash
# Compiler la biblioth√®que
make

# Voir les informations
make info

# Installer sur le syst√®me
sudo make install

# D√©sinstaller
sudo make uninstall

# Nettoyer
make clean
```

### Changer la version

Pour passer √† la version 1.3.0, modifiez simplement :

```makefile
MAJOR = 1  
MINOR = 3  # Chang√© de 2 √† 3  
PATCH = 0  # Reset √† 0  
```

Puis :
```bash
make clean  
make  
sudo make install  
```

---

## Compatibilit√© binaire (ABI)

### Qu'est-ce que l'ABI ?

**ABI** = **Application Binary Interface** (Interface Binaire d'Application)

C'est le "contrat" au niveau binaire entre une biblioth√®que et les programmes qui l'utilisent.

### Changements qui cassent l'ABI (version majeure)

‚ùå **N√©cessitent un changement de SONAME :**

1. **Modification de signature de fonction**
   ```c
   // Avant
   int addition(int a, int b);

   // Apr√®s (‚ùå INCOMPATIBLE)
   double addition(double a, double b);
   ```

2. **Modification de structure**
   ```c
   // Avant
   struct Point {
       int x;
       int y;
   };

   // Apr√®s (‚ùå INCOMPATIBLE)
   struct Point {
       double x;  // Type chang√©
       double y;
       double z;  // Membre ajout√©
   };
   ```

3. **Suppression de fonction**
   ```c
   // Suppression de deprecated_function() ‚Üí ‚ùå INCOMPATIBLE
   ```

4. **Modification de l'ordre des membres d'une structure**
   ```c
   // Avant
   struct Data {
       int a;
       char b;
   };

   // Apr√®s (‚ùå INCOMPATIBLE)
   struct Data {
       char b;  // Ordre invers√©
       int a;
   };
   ```

### Changements qui pr√©servent l'ABI (version mineure)

‚úÖ **Ne n√©cessitent PAS de changement de SONAME :**

1. **Ajout de nouvelles fonctions**
   ```c
   // Nouvelle fonction OK
   int soustraction(int a, int b);
   ```

2. **Ajout de membres √† la fin d'une structure (avec pr√©cautions)**
   ```c
   struct Point {
       int x;
       int y;
       int z;  // Ajout√© √† la fin, OK si g√©r√© correctement
   };
   ```

3. **Corrections de bugs internes** (sans changer l'interface)

4. **Optimisations de performance** (tant que le comportement reste identique)

---

## Strat√©gies de versioning avanc√©es

### Versionner les symboles

Pour une compatibilit√© encore plus fine, Linux permet de versionner les **symboles individuels** :

```c
// Fichier de version : libmath.ver
LIBMATH_1.0 {
    global:
        addition;
        multiplication;
    local:
        *;
};

LIBMATH_2.0 {
    global:
        addition_v2;  // Nouvelle version de addition
} LIBMATH_1.0;
```

**Compilation :**
```bash
gcc -shared -Wl,--version-script=libmath.ver -o libmath.so.2.0.0 math_utils.o
```

Cela permet d'avoir **plusieurs versions d'une m√™me fonction** dans la biblioth√®que !

### Convention Debian

Debian utilise une convention sp√©ciale :

```
libmath1           ‚Üí Package contenant libmath.so.1.*  
libmath2           ‚Üí Package contenant libmath.so.2.*  
libmath-dev        ‚Üí Package de d√©veloppement (headers + .so)  
```

Permet d'installer plusieurs versions majeures simultan√©ment via le gestionnaire de paquets.

---

## Commandes de diagnostic

### V√©rifier le SONAME d'une biblioth√®que

```bash
readelf -d libmath.so.1.2.3 | grep SONAME  
objdump -p libmath.so.1.2.3 | grep SONAME  
```

### V√©rifier les d√©pendances d'un ex√©cutable

```bash
readelf -d programme | grep NEEDED  
ldd programme  
```

### Afficher toutes les biblioth√®ques en cache

```bash
ldconfig -p | grep libmath
```

### Trouver quelle version est utilis√©e

```bash
# Voir o√π pointe le lien SONAME
ls -l /usr/lib/libmath.so.1

# Voir quelle version le programme charge r√©ellement
LD_DEBUG=libs ./programme 2>&1 | grep libmath
```

---

## Bonnes pratiques

### ‚úÖ Recommandations

1. **Toujours d√©finir un SONAME**
   ```bash
   gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.2.3 ...
   ```

2. **Suivre le versioning s√©mantique**
   - Incr√©menter MAJOR pour changements incompatibles
   - Incr√©menter MINOR pour nouvelles fonctionnalit√©s compatibles
   - Incr√©menter PATCH pour corrections de bugs

3. **Cr√©er tous les liens symboliques**
   ```bash
   ln -s libmath.so.1.2.3 libmath.so.1  # SONAME
   ln -s libmath.so.1 libmath.so        # Linker name
   ```

4. **Utiliser ldconfig apr√®s installation**
   ```bash
   sudo ldconfig
   ```

5. **Documenter les changements d'ABI**
   - Tenir un CHANGELOG
   - Marquer clairement les versions incompatibles

6. **Tester la compatibilit√©**
   - V√©rifier que les anciens programmes fonctionnent
   - Automatiser les tests de r√©gression

### ‚ùå Erreurs √† √©viter

1. **Oublier de d√©finir le SONAME**
   ```bash
   # ‚ùå Mauvais
   gcc -shared -o libmath.so.1.2.3 math_utils.o
   ```

2. **Utiliser le real name dans le SONAME**
   ```bash
   # ‚ùå Mauvais
   gcc -shared -Wl,-soname,libmath.so.1.2.3 -o libmath.so.1.2.3 ...

   # ‚úÖ Correct
   gcc -shared -Wl,-soname,libmath.so.1 -o libmath.so.1.2.3 ...
   ```

3. **Changer l'ABI sans incr√©menter la version majeure**
   ```c
   // Version 1.5.0 ‚Üí 1.6.0 (MINOR)
   // ‚ùå Mais changement int ‚Üí double (casse l'ABI !)
   ```

4. **Ne pas cr√©er les liens symboliques**

5. **Oublier d'ex√©cuter ldconfig**

---

## R√©sum√© des commandes essentielles

| Commande | Description |
|----------|-------------|
| `gcc -shared -Wl,-soname,libNOM.so.X ...` | Cr√©er une biblioth√®que avec SONAME |
| `ln -s libNOM.so.X.Y.Z libNOM.so.X` | Cr√©er le lien SONAME |
| `ln -s libNOM.so.X libNOM.so` | Cr√©er le linker name |
| `sudo ldconfig` | Mettre √† jour le cache des biblioth√®ques |
| `readelf -d lib.so \| grep SONAME` | V√©rifier le SONAME |
| `ldd programme` | Voir les d√©pendances d'un programme |
| `ldconfig -p \| grep libNOM` | Voir o√π est libNOM en cache |

---

## Points cl√©s √† retenir

- ‚úÖ **Versioning s√©mantique** : MAJOR.MINOR.PATCH (ex: 1.2.3)
- ‚úÖ **SONAME** contient uniquement la version **MAJEURE** (ex: `libmath.so.1`)
- ‚úÖ **Trois noms** : Real name (1.2.3), SONAME (1), Linker name (pas de version)
- ‚úÖ **Hi√©rarchie** : `libmath.so` ‚Üí `libmath.so.1` ‚Üí `libmath.so.1.2.3`
- ‚úÖ **Option GCC** : `-Wl,-soname,libmath.so.1` pour d√©finir le SONAME
- ‚úÖ **Compatibilit√©** : M√™me SONAME = binaire-compatible
- ‚úÖ **ldconfig** : Met √† jour le cache et les liens SONAME
- ‚úÖ **Changement majeur** : N√©cessite un nouveau SONAME (libmath.so.2)
- ‚úÖ **Coexistence** : Plusieurs versions majeures peuvent coexister sur le syst√®me

Dans la section suivante, nous verrons comment les programmes **r√©solvent dynamiquement les symboles au runtime** et le m√©canisme du "lazy binding".

‚è≠Ô∏è [R√©solution de symboles au runtime](/14-bibliotheques/02.3-resolution-symboles.md)
