üîù Retour au [Sommaire](/SOMMAIRE.md)

# 5.7.1 Installation et configuration

## Introduction

**clang-format** est un outil de formatage automatique de code pour C, C++ et d'autres langages. Il permet de :
- Formater automatiquement votre code selon des r√®gles d√©finies
- Assurer la coh√©rence du style dans tout votre projet
- Gagner du temps en √©vitant de formater manuellement
- √âliminer les d√©bats d'√©quipe sur le style de code

Dans cette section, nous allons voir comment installer et configurer clang-format sur Ubuntu, ainsi que les bases de son utilisation.

---

## Qu'est-ce que clang-format ?

clang-format fait partie du projet LLVM/Clang. C'est un outil en ligne de commande qui :
- Lit votre code source
- Applique des r√®gles de formatage
- R√©√©crit le code format√©

**Avantages :**
- ‚úÖ Formatage coh√©rent et automatique
- ‚úÖ Support de nombreux styles pr√©d√©finis (LLVM, Google, Chromium, Mozilla, WebKit, etc.)
- ‚úÖ Hautement configurable
- ‚úÖ Int√©gration facile avec les √©diteurs et IDE
- ‚úÖ Peut √™tre int√©gr√© dans le workflow CI/CD

---

## Installation sur Ubuntu

### M√©thode 1 : Installation via apt (recommand√©e pour d√©buter)

La fa√ßon la plus simple d'installer clang-format est d'utiliser le gestionnaire de paquets apt :

```bash
# Mettre √† jour la liste des paquets
sudo apt update

# Installer clang-format
sudo apt install clang-format
```

Cette commande installe la version par d√©faut disponible dans les d√©p√¥ts Ubuntu.

**V√©rifier l'installation :**
```bash
clang-format --version
```

Vous devriez voir quelque chose comme :
```
Ubuntu clang-format version 14.0.0-1ubuntu1
```

### M√©thode 2 : Installer une version sp√©cifique

Si vous souhaitez une version plus r√©cente ou sp√©cifique :

```bash
# Installer clang-format version 17
sudo apt install clang-format-17

# Cr√©er un lien symbolique pour l'utiliser par d√©faut
sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-17 100
```

**Versions disponibles :**
```bash
# Lister les versions disponibles
apt-cache search clang-format
```

**V√©rifier quelle version est active :**
```bash
clang-format --version
```

### M√©thode 3 : Installation depuis les d√©p√¥ts LLVM officiels

Pour obtenir la toute derni√®re version :

```bash
# Ajouter le d√©p√¥t LLVM
wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -  
sudo add-apt-repository "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs) main"  

# Mettre √† jour et installer
sudo apt update  
sudo apt install clang-format  
```

### V√©rification de l'installation

Pour v√©rifier que clang-format est bien install√© et accessible :

```bash
# V√©rifier la version
clang-format --version

# V√©rifier l'emplacement
which clang-format

# Afficher l'aide
clang-format --help
```

---

## Utilisation de base en ligne de commande

### Formater un fichier (aper√ßu)

Pour voir le r√©sultat du formatage sans modifier le fichier :

```bash
clang-format mon_fichier.c
```

Cette commande affiche le code format√© dans le terminal, mais **ne modifie pas le fichier**.

### Formater un fichier (modification en place)

Pour formater le fichier directement :

```bash
clang-format -i mon_fichier.c
```

L'option `-i` signifie "in-place" (sur place), le fichier sera modifi√© directement.

**Exemple pratique :**

Cr√©ez un fichier `test.c` mal format√© :
```c
#include <stdio.h>
int main(){int x=10;int y=20;if(x>5){printf("Grand\n");}return 0;}
```

Formatez-le :
```bash
clang-format -i test.c
```

Le fichier devient :
```c
#include <stdio.h>
int main() {
  int x = 10;
  int y = 20;
  if (x > 5) {
    printf("Grand\n");
  }
  return 0;
}
```

### Formater plusieurs fichiers

**Formater tous les fichiers .c et .h dans le r√©pertoire courant :**
```bash
clang-format -i *.c *.h
```

**Formater r√©cursivement tous les fichiers dans un projet :**
```bash
find . -name "*.c" -o -name "*.h" | xargs clang-format -i
```

**Alternative avec des sous-r√©pertoires :**
```bash
find . -type f \( -name "*.c" -o -name "*.h" \) -exec clang-format -i {} \;
```

### V√©rifier le formatage sans modifier

Pour v√©rifier si un fichier est correctement format√© :

```bash
clang-format --dry-run --Werror mon_fichier.c
```

- `--dry-run` : Ne modifie pas le fichier
- `--Werror` : Retourne une erreur si le formatage n'est pas correct

Cette commande est utile pour les scripts CI/CD.

---

## Configuration : Le fichier .clang-format

### Qu'est-ce que .clang-format ?

Le fichier `.clang-format` est un fichier de configuration qui d√©finit les r√®gles de formatage pour votre projet. clang-format cherche ce fichier :
1. Dans le r√©pertoire du fichier source
2. Dans les r√©pertoires parents (remonte l'arborescence)
3. Jusqu'√† trouver un fichier `.clang-format` ou atteindre la racine

**Avantage :** Placez un seul fichier `.clang-format` √† la racine de votre projet et tous les fichiers seront format√©s de la m√™me mani√®re.

### Cr√©er un fichier .clang-format de base

**Option 1 : Utiliser un style pr√©d√©fini**

```bash
# Cr√©er un .clang-format bas√© sur le style LLVM
clang-format -style=llvm -dump-config > .clang-format
```

**Option 2 : Cr√©er manuellement**

Cr√©ez un fichier `.clang-format` √† la racine de votre projet :

```yaml
---
# Configuration clang-format de base
Language: Cpp  
BasedOnStyle: LLVM  

# Indentation
IndentWidth: 4  
TabWidth: 4  
UseTab: Never  

# Accolades
BreakBeforeBraces: Linux

# Largeur de ligne
ColumnLimit: 100

# Espaces
SpaceAfterCStyleCast: false  
SpaceBeforeParens: ControlStatements  
SpaceBeforeAssignmentOperators: true  

# Alignement
AlignConsecutiveAssignments: false  
AlignConsecutiveDeclarations: false  

# Autres
AllowShortFunctionsOnASingleLine: None  
AllowShortIfStatementsOnASingleLine: Never  
AllowShortLoopsOnASingleLine: false  
...
```

### Styles pr√©d√©finis disponibles

clang-format propose plusieurs styles pr√©d√©finis :

| Style | Description | Utilisation typique |
|-------|-------------|---------------------|
| **LLVM** | Style du projet LLVM | Projets C/C++ modernes, √©quilibr√© |
| **Google** | Style guide de Google | Projets suivant les conventions Google |
| **Chromium** | Style du projet Chromium | Navigateur Chromium |
| **Mozilla** | Style du projet Mozilla | Firefox et projets Mozilla |
| **WebKit** | Style du moteur WebKit | Safari et projets WebKit |
| **Microsoft** | Style Visual Studio | Projets Windows/Visual Studio |
| **GNU** | Style GNU | Projets GNU (GCC, etc.) |

**G√©n√©rer la configuration d'un style pr√©d√©fini :**
```bash
# Style LLVM
clang-format -style=llvm -dump-config > .clang-format

# Style Google
clang-format -style=google -dump-config > .clang-format

# Style GNU
clang-format -style=gnu -dump-config > .clang-format
```

### Exemple : Comparaison des styles

**Code source original :**
```c
#include <stdio.h>
int main(){int x=10;if(x>5){printf("Grand\n");}return 0;}
```

**Style LLVM :**
```c
#include <stdio.h>
int main() {
  int x = 10;
  if (x > 5) {
    printf("Grand\n");
  }
  return 0;
}
```

**Style Google :**
```c
#include <stdio.h>
int main() {
  int x = 10;
  if (x > 5) {
    printf("Grand\n");
  }
  return 0;
}
```

**Style GNU :**
```c
#include <stdio.h>
int  
main ()  
{
  int x = 10;
  if (x > 5)
    {
      printf ("Grand\n");
    }
  return 0;
}
```

**Style Linux Kernel :**
```c
#include <stdio.h>
int main()
{
        int x = 10;
        if (x > 5) {
                printf("Grand\n");
        }
        return 0;
}
```

---

## Options de configuration importantes

Voici les options les plus couramment utilis√©es dans `.clang-format` :

### Indentation et espacement

```yaml
# Nombre d'espaces pour l'indentation
IndentWidth: 4

# Largeur d'une tabulation
TabWidth: 4

# Utiliser des espaces au lieu de tabs
UseTab: Never  # Options: Never, Always, ForIndentation, ForContinuationAndIndentation

# Indenter les directives du pr√©processeur (#include, #define, etc.)
IndentPPDirectives: None  # Options: None, AfterHash, BeforeHash

# Indenter les √©tiquettes case dans un switch
IndentCaseLabels: false
```

### Style des accolades

```yaml
# Style d'accolades
BreakBeforeBraces: Linux
# Options:
#   Attach     : int foo() {
#   Linux      : int foo()\n{
#   Mozilla    : int foo()\n{  (sauf fonctions)
#   Stroustrup : int foo()\n{  (else sur m√™me ligne)
#   Allman     : int foo()\n{  (toujours nouvelle ligne)
#   GNU        : int foo()\n{\n  (2 espaces, style GNU)
#   WebKit     : Style WebKit
#   Custom     : Utiliser BraceWrapping pour personnaliser
```

### Longueur des lignes

```yaml
# Nombre maximum de caract√®res par ligne
ColumnLimit: 100  # 0 = pas de limite

# P√©nalit√© pour d√©passer la limite
PenaltyExcessCharacter: 1000000
```

### Espaces

```yaml
# Espaces autour des op√©rateurs d'affectation
SpaceBeforeAssignmentOperators: true

# Espaces avant les parenth√®ses
SpaceBeforeParens: ControlStatements
# Options: Never, ControlStatements, Always, NonEmptyParentheses

# Espaces apr√®s les cast C-style
SpaceAfterCStyleCast: false

# Espaces dans les conteneurs vides
SpaceInEmptyParentheses: false

# Espaces dans les parenth√®ses
SpacesInParentheses: false

# Espaces dans les crochets
SpacesInSquareBrackets: false
```

### Alignement

```yaml
# Aligner les affectations cons√©cutives
AlignConsecutiveAssignments: false

# Aligner les d√©clarations cons√©cutives
AlignConsecutiveDeclarations: false

# Aligner les commentaires de fin de ligne
AlignTrailingComments: true
```

### Fonctions et conditions courtes

```yaml
# Autoriser les fonctions courtes sur une ligne
AllowShortFunctionsOnASingleLine: None
# Options: None, InlineOnly, Empty, Inline, All

# Autoriser les if courts sur une ligne
AllowShortIfStatementsOnASingleLine: Never
# Options: Never, WithoutElse, OnlyFirstIf, AllIfsAndElse

# Autoriser les boucles courtes sur une ligne
AllowShortLoopsOnASingleLine: false
```

### Saut de lignes

```yaml
# Toujours casser avant les accolades de fonction multiligne
AlwaysBreakAfterDefinitionReturnType: None

# Casser apr√®s le type de retour de fonction
AlwaysBreakAfterReturnType: None

# Nombre maximum de lignes cons√©cutives vides
MaxEmptyLinesToKeep: 1

# Garder les sauts de ligne dans les param√®tres
BinPackParameters: true
```

---

## Configuration recommand√©e pour d√©butants

Voici une configuration simple et efficace pour commencer :

```yaml
---
# Configuration clang-format simple pour d√©butants
Language: Cpp  
BasedOnStyle: LLVM  

# === INDENTATION ===
IndentWidth: 4                    # 4 espaces par niveau  
TabWidth: 4  
UseTab: Never                     # Toujours utiliser des espaces  

# === ACCOLADES ===
BreakBeforeBraces: Linux          # Style K&R/Linux
# Fonctions : accolade sur nouvelle ligne
# if/while/for : accolade sur m√™me ligne

# === LARGEUR DE LIGNE ===
ColumnLimit: 100                  # Max 100 caract√®res par ligne

# === ESPACES ===
SpaceAfterCStyleCast: false       # int *p = (int *)ptr; (pas d'espace)  
SpaceBeforeParens: ControlStatements  # if (condition) mais fonction()  
SpaceBeforeAssignmentOperators: true  # x = 10; (avec espace)  
SpacesInParentheses: false        # (x + y) et non ( x + y )  

# === ALIGNEMENT ===
AlignConsecutiveAssignments: false  
AlignConsecutiveDeclarations: false  
AlignTrailingComments: true       # Aligner les commentaires de fin de ligne  
PointerAlignment: Right           # int *ptr; (pointeur coll√© au nom)  

# === FONCTIONS ET CONDITIONS COURTES ===
AllowShortFunctionsOnASingleLine: None     # Jamais de fonction sur une ligne  
AllowShortIfStatementsOnASingleLine: Never # Jamais de if sur une ligne  
AllowShortLoopsOnASingleLine: false        # Jamais de boucle sur une ligne  

# === LIGNES VIDES ===
MaxEmptyLinesToKeep: 1            # Maximum 1 ligne vide cons√©cutive  
KeepEmptyLinesAtTheStartOfBlocks: false  # Pas de ligne vide au d√©but des blocs  

# === INCLUDES ===
SortIncludes: true                # Trier les #include  
IncludeBlocks: Regroup           # Regrouper les includes par cat√©gorie  

# === DIVERS ===
IndentCaseLabels: false          # Ne pas indenter les case dans un switch
...
```

**Sauvegarder ce fichier comme `.clang-format` √† la racine de votre projet.**

---

## Tester votre configuration

### Cr√©er un fichier de test

Cr√©ez un fichier `test_format.c` avec du code mal format√© :

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
int main(){  
int x=10,y=20,z;  
z=x+y;  
if(z>25){  
printf("Grand\n");  
}else{
printf("Petit\n");
}
for(int i=0;i<5;i++){  
printf("%d ",i);  
}
return 0;
}
```

### Appliquer le formatage

```bash
# Formater avec votre .clang-format
clang-format -i test_format.c
```

### R√©sultat attendu

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main()
{
    int x = 10, y = 20, z;
    z = x + y;

    if (z > 25) {
        printf("Grand\n");
    } else {
        printf("Petit\n");
    }

    for (int i = 0; i < 5; i++) {
        printf("%d ", i);
    }

    return 0;
}
```

---

## Utilisation avanc√©e en ligne de commande

### Formater avec un style sans fichier .clang-format

```bash
# Utiliser directement un style pr√©d√©fini
clang-format -style=google -i mon_fichier.c

# Utiliser un style avec quelques modifications
clang-format -style="{BasedOnStyle: llvm, IndentWidth: 4}" -i mon_fichier.c
```

### Formater seulement une partie du fichier

```bash
# Formater les lignes 10 √† 20
clang-format -lines=10:20 mon_fichier.c

# Formater plusieurs plages
clang-format -lines=10:20 -lines=30:40 mon_fichier.c
```

### Sp√©cifier le fichier de configuration

```bash
# Utiliser un fichier de configuration sp√©cifique
clang-format -style=file:/chemin/vers/.clang-format -i mon_fichier.c
```

### Afficher les diff√©rences

```bash
# Voir ce qui sera chang√© (diff)
clang-format mon_fichier.c | diff mon_fichier.c -
```

---

## R√©solution de probl√®mes

### Probl√®me : clang-format not found

**Sympt√¥me :**
```bash
bash: clang-format: command not found
```

**Solution :**
```bash
# V√©rifier si install√©
dpkg -l | grep clang-format

# R√©installer
sudo apt update  
sudo apt install clang-format  
```

### Probl√®me : Le formatage ne s'applique pas

**Causes possibles :**
1. Le fichier `.clang-format` n'est pas dans le bon r√©pertoire
2. Le fichier `.clang-format` contient des erreurs de syntaxe

**Solutions :**
```bash
# V√©rifier o√π clang-format cherche la config
clang-format -style=file -dump-config mon_fichier.c

# Valider la syntaxe de votre .clang-format
clang-format -style=file:.clang-format -dump-config > /dev/null
```

### Probl√®me : Le style ne correspond pas √† vos attentes

**Solution :** Comparez avec un style pr√©d√©fini :

```bash
# G√©n√©rer la config du style LLVM
clang-format -style=llvm -dump-config > llvm-style.yaml

# Comparer avec votre config
diff .clang-format llvm-style.yaml
```

### Probl√®me : Certains fichiers ne sont pas format√©s

**V√©rifiez :**
```bash
# Voir les options appliqu√©es
clang-format -style=file -dump-config mon_fichier.c | grep Language
```

Assurez-vous que `Language: Cpp` est bien d√©fini dans votre `.clang-format`.

---

## Organisation d'un projet avec clang-format

### Structure recommand√©e

```
mon_projet/
‚îú‚îÄ‚îÄ .clang-format          ‚Üê Configuration √† la racine
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.c
‚îÇ   ‚îú‚îÄ‚îÄ module1.c
‚îÇ   ‚îî‚îÄ‚îÄ module2.c
‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îú‚îÄ‚îÄ module1.h
‚îÇ   ‚îî‚îÄ‚îÄ module2.h
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_main.c
‚îî‚îÄ‚îÄ README.md
```

Tous les fichiers utiliseront automatiquement le `.clang-format` de la racine.

### Script de formatage du projet

Cr√©ez un script `format.sh` √† la racine :

```bash
#!/bin/bash
# Script pour formater tout le projet

echo "Formatage du code en cours..."

# Trouver et formater tous les fichiers .c et .h
find src include tests -type f \( -name "*.c" -o -name "*.h" \) \
    -exec clang-format -i {} \;

echo "Formatage termin√© !"
```

Rendez-le ex√©cutable :
```bash
chmod +x format.sh
```

Utilisez-le :
```bash
./format.sh
```

---

## Bonnes pratiques

### 1. Commiter le fichier .clang-format

Toujours inclure `.clang-format` dans votre d√©p√¥t Git :

```bash
git add .clang-format  
git commit -m "Ajout de la configuration clang-format"  
```

**Pourquoi ?** Tous les contributeurs utiliseront le m√™me style.

### 2. Formater avant de commiter

Prenez l'habitude de formater avant chaque commit :

```bash
# Formater les fichiers modifi√©s
git diff --name-only --cached | grep -E '\.(c|h)$' | xargs clang-format -i

# Puis commiter
git add .  
git commit -m "Mon commit"  
```

### 3. Documenter le style dans le README

Ajoutez une section dans votre `README.md` :

```markdown
## Style de code

Ce projet utilise clang-format pour le formatage automatique.

### Installation
```bash
sudo apt install clang-format
```

### Utilisation
```bash
# Formater tout le projet
./format.sh

# Formater un fichier
clang-format -i mon_fichier.c
```

### Configuration
Le fichier `.clang-format` √† la racine d√©finit le style du projet.
```

### 4. Ne pas formater le code legacy progressivement

Si vous int√©grez clang-format dans un projet existant :

**Option 1 :** Formater tout d'un coup (commit d√©di√©)
```bash
find . -name "*.c" -o -name "*.h" | xargs clang-format -i  
git commit -m "Formatage: application de clang-format sur tout le projet"  
```

**Option 2 :** Formater seulement les nouveaux fichiers ou modifications

### 5. Exceptions : D√©sactiver temporairement le formatage

Parfois, vous voulez un formatage manuel sp√©cifique :

```c
// clang-format off
int tableau[3][3] = {
    {1, 2, 3},
    {4, 5, 6},
    {7, 8, 9}
};
// clang-format on
```

**‚ö†Ô∏è √Ä utiliser avec parcimonie !**

---

## R√©sum√©

### Installation

```bash
# Installation simple
sudo apt install clang-format

# V√©rification
clang-format --version
```

### Utilisation de base

```bash
# Formater un fichier
clang-format -i mon_fichier.c

# Formater plusieurs fichiers
clang-format -i *.c *.h

# Formater tout le projet
find . -name "*.c" -o -name "*.h" | xargs clang-format -i
```

### Configuration

1. Cr√©er `.clang-format` √† la racine du projet
2. Partir d'un style pr√©d√©fini : `clang-format -style=llvm -dump-config > .clang-format`
3. Personnaliser selon vos besoins
4. Commiter le fichier dans Git

### Points cl√©s

- ‚úÖ clang-format assure un formatage coh√©rent
- ‚úÖ Le fichier `.clang-format` d√©finit les r√®gles
- ‚úÖ Plusieurs styles pr√©d√©finis disponibles
- ‚úÖ Facile √† int√©grer dans le workflow
- ‚úÖ S'int√®gre avec les √©diteurs et le CI/CD

---

## Pour aller plus loin

Dans les prochaines sections, vous d√©couvrirez :
- **5.7.2 Styles courants** : Comparaison d√©taill√©e des styles pr√©d√©finis
- **5.7.3 Int√©gration IDE** : Configuration dans VS Code, Vim, etc.
- **5.7.4 Pre-commit hooks Git** : Automatiser le formatage avant les commits
- **5.7.5 Formatage dans le CI/CD** : V√©rification automatique dans GitHub Actions

L'utilisation de clang-format est une excellente habitude √† prendre d√®s maintenant. Cela vous fera gagner du temps et garantira un code propre et professionnel !

‚è≠Ô∏è [Styles courants](/05-operateurs-et-controle/07.2-styles-courants.md)
