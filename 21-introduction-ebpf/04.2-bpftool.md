üîù Retour au [Sommaire](/SOMMAIRE.md)

# 21.4.2 bpftool

## Introduction

**bpftool** est l'outil en ligne de commande officiel du kernel Linux pour **inspecter, g√©rer, et debugger** les programmes eBPF. Si libbpf est la biblioth√®que de d√©veloppement, bpftool est le "couteau suisse" qui permet de voir et manipuler tout ce qui concerne eBPF sur un syst√®me.

Imaginez que vous ayez besoin de :
- Lister tous les programmes eBPF actifs sur votre syst√®me
- Inspecter le contenu d'une BPF map
- Debugger pourquoi votre programme eBPF ne se charge pas
- G√©n√©rer du code skeleton pour libbpf
- V√©rifier les informations BTF du kernel

**bpftool fait tout cela et bien plus encore**, et c'est un outil essentiel pour tout ing√©nieur travaillant avec eBPF.

---

## Qu'est-ce que bpftool ?

### D√©finition simple

**bpftool** est un utilitaire en ligne de commande qui permet de :

1. **Inspecter** : Voir tous les objets eBPF (programmes, maps, links, BTF)
2. **G√©rer** : Charger, d√©tacher, √©pingler des objets eBPF
3. **Debugger** : Examiner le contenu des maps, les stats des programmes
4. **G√©n√©rer** : Cr√©er des skeletons, extraire des BTF, dumper du bytecode
5. **Analyser** : Profiler les programmes, voir les verifier logs

### Analogie

Si eBPF √©tait un syst√®me de fichiers :
- **libbpf** serait la biblioth√®que pour √©crire/lire des fichiers (comme `fopen`, `fwrite`)
- **bpftool** serait l'√©quivalent de `ls`, `cat`, `stat`, `find` ‚Äî les outils pour inspecter et naviguer

---

## Installation

### Ubuntu/Debian

```bash
# bpftool est g√©n√©ralement inclus dans linux-tools
sudo apt update  
sudo apt install -y linux-tools-common linux-tools-generic  

# Ou linux-tools pour votre kernel sp√©cifique
sudo apt install -y linux-tools-$(uname -r)

# V√©rifier l'installation
bpftool version
```

**Note :** Sur Ubuntu, bpftool peut √™tre dans `/usr/lib/linux-tools/*/bpftool`. Cr√©er un lien symbolique si n√©cessaire :

```bash
sudo ln -s /usr/lib/linux-tools/$(uname -r)/bpftool /usr/local/bin/bpftool
```

### Fedora/RHEL

```bash
sudo dnf install -y bpftool

# V√©rifier
bpftool version
```

### Compilation depuis les sources

```bash
# Cloner le kernel Linux
git clone --depth 1 https://github.com/torvalds/linux.git  
cd linux/tools/bpf/bpftool  

# Compiler
make

# Installer
sudo make install
```

### V√©rification

```bash
$ bpftool version
bpftool v7.0.0  
features: libbfd, libbpf 1.2, skeletons  

$ bpftool --help
Usage: bpftool [OPTIONS] OBJECT { COMMAND | help }
       bpftool batch file FILE
       bpftool version

       OBJECT := { prog | map | link | cgroup | perf | net | feature | btf | gen | struct_ops | iter }
       OPTIONS := { {-j|--json} [{-p|--pretty}] | {-d|--debug} | {-l|--legacy} }
```

---

## Structure des commandes bpftool

bpftool utilise une structure hi√©rarchique intuitive :

```
bpftool <OBJECT> <COMMAND> [OPTIONS]
```

### Les objets principaux

| Objet | Description |
|-------|-------------|
| **prog** | Programmes eBPF charg√©s |
| **map** | BPF maps (structures de donn√©es) |
| **link** | Attachements de programmes aux hooks |
| **btf** | BPF Type Format (informations de types) |
| **gen** | G√©n√©ration de code (skeleton, etc.) |
| **cgroup** | Programmes attach√©s aux cgroups |
| **perf** | Programmes attach√©s aux √©v√©nements perf |
| **net** | Programmes r√©seau (XDP, TC) |
| **iter** | BPF iterators |
| **feature** | Features eBPF support√©es par le kernel |
| **struct_ops** | BPF structure operations |

### Les commandes courantes

| Commande | Description |
|----------|-------------|
| **list** / **show** | Lister les objets |
| **dump** | Afficher le contenu (bytecode, maps, BTF) |
| **load** | Charger un programme |
| **attach** / **detach** | Attacher/d√©tacher un programme |
| **pin** / **unpin** | √âpingler/d√©s√©pingler dans le filesystem |
| **update** | Modifier une map |
| **lookup** | Rechercher dans une map |
| **create** | Cr√©er un objet |
| **delete** | Supprimer une entr√©e de map |

---

## bpftool prog : G√©rer les programmes eBPF

### Lister tous les programmes

```bash
$ sudo bpftool prog list
1: cgroup_skb  tag 7be49e3934a125ba
    loaded_at 2024-11-27T10:30:15+0000  uid 0
    xlated 296B  jited 229B  memlock 4096B  map_ids 1,2

23: tracepoint  name trace_execve  tag a3f21b4c5d6e7f89
    loaded_at 2024-11-27T11:45:23+0000  uid 0
    xlated 512B  jited 387B  memlock 4096B  map_ids 5
    btf_id 45
    pids systemd(1234)

42: kprobe  name trace_tcp_sendmsg  tag 9c8e7d6f5a4b3c2d
    loaded_at 2024-11-27T12:00:01+0000  uid 0
    xlated 1024B  jited 768B  memlock 8192B  map_ids 8,9
    btf_id 67
    pids my_ebpf_tool(5678)
```

**Informations affich√©es :**
- **ID** : Identifiant unique du programme
- **Type** : kprobe, tracepoint, xdp, tc, etc.
- **Tag** : Hash du bytecode (pour identifier les versions)
- **loaded_at** : Timestamp de chargement
- **xlated** : Taille du bytecode apr√®s traduction
- **jited** : Taille du code JIT compil√©
- **map_ids** : IDs des maps utilis√©es
- **btf_id** : ID des informations BTF
- **pids** : Processus qui ont charg√© le programme

### Afficher les d√©tails d'un programme

```bash
# Par ID
$ sudo bpftool prog show id 23

# Avec format JSON (utile pour parsing)
$ sudo bpftool prog show id 23 --json --pretty
{
    "id": 23,
    "type": "tracepoint",
    "name": "trace_execve",
    "tag": "a3f21b4c5d6e7f89",
    "loaded_at": 1701085523,
    "uid": 0,
    "bytes_xlated": 512,
    "jited": true,
    "bytes_jited": 387,
    "bytes_memlock": 4096,
    "map_ids": [5],
    "btf_id": 45,
    "pids": [{
        "pid": 1234,
        "comm": "systemd"
    }]
}
```

### Dumper le bytecode eBPF

```bash
# Bytecode eBPF (instructions)
$ sudo bpftool prog dump xlated id 23
int trace_execve(struct trace_event_raw_sched_process_exec * ctx):
; int trace_execve(struct trace_event_raw_sched_process_exec *ctx) {
   0: (85) call bpf_get_current_pid_tgid#114672
; pid_t pid = bpf_get_current_pid_tgid() >> 32;
   1: (77) r0 >>= 32
   2: (63) *(u32 *)(r10 -4) = r0
; bpf_printk("Exec: PID=%d\n", pid);
   3: (18) r1 = 0xffff888012345678
   5: (b7) r2 = 14
   6: (bf) r3 = r10
   7: (07) r3 += -4
   8: (85) call bpf_trace_printk#6
   9: (b7) r0 = 0
; return 0;
  10: (95) exit
```

**Explications :**
- Instructions num√©rot√©es (0-10)
- Code C source original en commentaires (avec debug symbols)
- Instructions eBPF avec registres (r0-r10)

### Dumper le code JIT (assembleur natif)

```bash
$ sudo bpftool prog dump jited id 23
int trace_execve(struct trace_event_raw_sched_process_exec * ctx):  
bpf_prog_a3f21b4c5d6e7f89_trace_execve:  
; int trace_execve(struct trace_event_raw_sched_process_exec *ctx) {
   0:   push   %rbp
   1:   mov    %rsp,%rbp
   4:   sub    $0x10,%rsp
   8:   callq  0xffffffffa0001234  ; bpf_get_current_pid_tgid
  13:   shr    $0x20,%rax
  17:   mov    %eax,-0x4(%rbp)
  20:   mov    $0xffff888012345678,%rdi
  30:   mov    $0xe,%esi
  35:   lea    -0x4(%rbp),%rdx
  39:   callq  0xffffffffa0002345  ; bpf_trace_printk
  44:   xor    %eax,%eax
  46:   leaveq
  47:   retq
```

**C'est le code assembleur x86-64 qui s'ex√©cute r√©ellement sur le CPU !**

### Afficher les statistiques d'ex√©cution

```bash
$ sudo bpftool prog show id 23 --json | jq '.run_time_ns, .run_cnt'
1234567890  # Temps total d'ex√©cution (ns)
987654      # Nombre d'ex√©cutions
```

### √âpingler un programme dans le filesystem

L'√©pinglage (pinning) permet de garder un objet eBPF actif m√™me apr√®s la fermeture du programme qui l'a cr√©√©.

```bash
# Cr√©er le r√©pertoire de pinning (convention)
sudo mkdir -p /sys/fs/bpf/myapp

# √âpingler un programme
sudo bpftool prog pin id 23 /sys/fs/bpf/myapp/trace_execve

# Lister les objets √©pingl√©s
ls -la /sys/fs/bpf/myapp/
-rw------- 1 root root 0 Nov 27 10:30 trace_execve

# R√©utiliser le programme √©pingl√©
sudo bpftool prog show pinned /sys/fs/bpf/myapp/trace_execve

# D√©s√©pingler
sudo rm /sys/fs/bpf/myapp/trace_execve
```

**Cas d'usage :** Partager un programme eBPF entre plusieurs processus sans le recharger.

---

## bpftool map : G√©rer les BPF maps

### Lister toutes les maps

```bash
$ sudo bpftool map list
1: hash  name counts  flags 0x0
    key 4B  value 8B  max_entries 1024  memlock 102400B
    btf_id 12

5: ringbuf  name events  flags 0x0
    key 0B  value 0B  max_entries 262144  memlock 266240B

8: array  name config  flags 0x0
    key 4B  value 4B  max_entries 10  memlock 4096B
    pinned /sys/fs/bpf/myapp/config
```

**Informations affich√©es :**
- **ID** et **nom**
- **Type** : hash, array, ringbuf, lru_hash, etc.
- **Taille cl√©/valeur**
- **max_entries** : Capacit√© maximale
- **memlock** : M√©moire verrouill√©e utilis√©e
- **pinned** : Chemin si √©pingl√©

### Afficher le contenu d'une map

```bash
# Map de type hash : afficher toutes les entr√©es
$ sudo bpftool map dump id 1
key: 00 00 03 d2  value: 2a 00 00 00 00 00 00 00  
key: 00 00 07 d3  value: 15 00 00 00 00 00 00 00  
key: 00 00 0f a4  value: 03 00 00 00 00 00 00 00  

# Format plus lisible (avec BTF si disponible)
$ sudo bpftool map dump id 1 --json --pretty
[{
    "key": 978,
    "value": 42
},{
    "key": 2003,
    "value": 21
},{
    "key": 4004,
    "value": 3
}]
```

### Lookup (recherche) dans une map

```bash
# Chercher une cl√© sp√©cifique (format hexad√©cimal, little-endian)
$ sudo bpftool map lookup id 1 key hex d2 03 00 00
key: d2 03 00 00  value: 2a 00 00 00 00 00 00 00
```

### Mettre √† jour une map

```bash
# Ins√©rer ou mettre √† jour une entr√©e
$ sudo bpftool map update id 1 key 100 0 0 0 value 999 0 0 0 0 0 0 0

# V√©rifier
$ sudo bpftool map lookup id 1 key 100 0 0 0
key: 64 00 00 00  value: e7 03 00 00 00 00 00 00
```

### Supprimer une entr√©e

```bash
$ sudo bpftool map delete id 1 key 100 0 0 0
```

### Cr√©er une map depuis la ligne de commande

```bash
# Cr√©er une hash map
$ sudo bpftool map create /sys/fs/bpf/test_map \
    type hash \
    key 4 \
    value 8 \
    entries 256 \
    name test_map

# V√©rifier
$ sudo bpftool map show pinned /sys/fs/bpf/test_map
```

### Vider une map

```bash
# Obtenir toutes les cl√©s et les supprimer
$ sudo bpftool map dump id 1 | grep "^key:" | while read -r line; do
    key=$(echo $line | awk '{print $2, $3, $4, $5}')
    sudo bpftool map delete id 1 key $key
done
```

---

## bpftool link : G√©rer les attachements

Les **links** repr√©sentent les connexions entre programmes eBPF et leurs points d'attache.

### Lister tous les links

```bash
$ sudo bpftool link list
1: tracepoint  prog 23
    tracepoint sched_process_exec

5: kprobe  prog 42
    kprobe tcp_sendmsg

12: cgroup  prog 67
    cgroup_id 8234  attach_type ingress
```

### Afficher les d√©tails d'un link

```bash
$ sudo bpftool link show id 1 --json --pretty
{
    "id": 1,
    "type": "tracepoint",
    "prog_id": 23,
    "tracepoint": {
        "tp_name": "sched_process_exec"
    }
}
```

### D√©tacher un link

```bash
# Attention : cela d√©tache le programme du hook !
$ sudo bpftool link detach id 1
```

### √âpingler un link

```bash
$ sudo bpftool link pin id 5 /sys/fs/bpf/myapp/tcp_link
```

---

## bpftool btf : Inspecter les informations de types

### Lister les BTF IDs

```bash
$ sudo bpftool btf list
1: name [vmlinux]  size 5234567B
45: name [trace_execve]  size 1234B  prog_ids 23  map_ids 5
67: name [tcp_monitor]  size 2345B  prog_ids 42  map_ids 8,9
```

### Dumper les informations BTF du kernel

```bash
# Tout le vmlinux BTF (tr√®s long !)
$ sudo bpftool btf dump file /sys/kernel/btf/vmlinux

# Chercher un type sp√©cifique
$ sudo bpftool btf dump file /sys/kernel/btf/vmlinux | grep "struct task_struct"
[123] STRUCT 'task_struct' size=9472 vlen=232
    'pid' type_id=1 bits_offset=2560
    'tgid' type_id=1 bits_offset=2592
    'comm' type_id=4 bits_offset=6912
    ...
```

### Dumper le BTF d'un programme eBPF

```bash
$ sudo bpftool btf dump prog id 23
[1] PTR '(anon)' type_id=2
[2] STRUCT 'trace_event_raw_sched_process_exec' size=64 vlen=8
    'filename' type_id=3 bits_offset=0
    'pid' type_id=4 bits_offset=512
    'old_pid' type_id=4 bits_offset=544
    ...
```

### G√©n√©rer un vmlinux.h

```bash
# Extraire toutes les d√©finitions de types en un header C
$ sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h

# Taille typique : 5-10 MB !
$ ls -lh vmlinux.h
-rw-r--r-- 1 user user 8.3M Nov 27 10:30 vmlinux.h
```

**Ce fichier est essentiel pour d√©velopper avec libbpf + CO-RE.**

---

## bpftool gen : G√©n√©ration de code

### G√©n√©rer un skeleton

Le skeleton est du code C g√©n√©r√© automatiquement pour simplifier l'utilisation de libbpf :

```bash
# Compiler le programme eBPF
$ clang -O2 -target bpf -g -c program.bpf.c -o program.bpf.o

# G√©n√©rer le skeleton
$ bpftool gen skeleton program.bpf.o > program.skel.h

# Utiliser dans votre code
$ cat loader.c
#include "program.skel.h"

int main() {
    struct program_bpf *skel;

    skel = program_bpf__open_and_load();
    if (!skel) {
        fprintf(stderr, "Failed\n");
        return 1;
    }

    program_bpf__attach(skel);

    // ...

    program_bpf__destroy(skel);
    return 0;
}
```

### G√©n√©rer un subskeleton (pour maps partag√©es)

```bash
# Pour partager des maps entre plusieurs programmes
$ bpftool gen subskeleton shared_map.bpf.o > shared_map.subskel.h
```

### G√©n√©rer un object file depuis BTF

```bash
$ bpftool gen object output.o input.bpf.o
```

---

## bpftool feature : V√©rifier les capacit√©s du kernel

### Lister toutes les features support√©es

```bash
$ sudo bpftool feature
Scanning system configuration...

eBPF program types:
 - socket_filter is available
 - kprobe is available
 - tracepoint is available
 - xdp is available
 - tc is available
 - cgroup_skb is available
 ...

eBPF map types:
 - hash is available
 - array is available
 - ringbuf is available
 - lru_hash is available
 ...

eBPF helpers:
 - bpf_map_lookup_elem is available
 - bpf_get_current_pid_tgid is available
 - bpf_trace_printk is available
 ...

System config:
 - bpf() syscall is available
 - JIT compiler is enabled
 - BPF LSM is available
```

### V√©rifier une feature sp√©cifique

```bash
# Format JSON pour parsing
$ sudo bpftool feature --json | jq '.helpers[] | select(.name == "bpf_probe_read_kernel")'
{
  "name": "bpf_probe_read_kernel",
  "is_available": true
}
```

**Cas d'usage :** V√©rifier la compatibilit√© avant de d√©ployer un outil eBPF.

---

## bpftool net : Programmes r√©seau

### Lister les programmes XDP

```bash
$ sudo bpftool net list
xdp:  
eth0(2) driver id 42  

tc:  
eth0(2) clsact/ingress tc_filter id 67  
eth0(2) clsact/egress tc_filter id 68  
```

### Afficher les d√©tails

```bash
$ sudo bpftool net show dev eth0
xdp:  
eth0(2) driver id 42 tag a3f21b4c5d6e7f89 jited  

tc:  
eth0(2) clsact/ingress tc_filter id 67 tag 9c8e7d6f5a4b3c2d jited  
```

### D√©tacher un programme XDP

```bash
# M√©thode bpftool (√† √©viter, pr√©f√©rer l'outil qui l'a attach√©)
$ sudo bpftool net detach xdp dev eth0
```

---

## bpftool cgroup : Programmes attach√©s aux cgroups

### Lister les programmes par cgroup

```bash
$ sudo bpftool cgroup tree /sys/fs/cgroup/
CgroupPath
/sys/fs/cgroup/
    ingress         id 67
    egress          id 68
/sys/fs/cgroup/system.slice
    ingress         id 69
```

### Afficher les programmes d'un cgroup sp√©cifique

```bash
$ sudo bpftool cgroup show /sys/fs/cgroup/system.slice
ID       AttachType      AttachFlags     Name
67       ingress                         filter_ingress
68       egress                          filter_egress
```

### Attacher un programme √† un cgroup

```bash
$ sudo bpftool cgroup attach /sys/fs/cgroup/system.slice \
    ingress id 23
```

---

## bpftool perf : Programmes perf_event

### Lister les programmes attach√©s aux √©v√©nements perf

```bash
$ sudo bpftool perf list
pid 1234  fd 3: prog_id 23  tracepoint  sched_process_exec  
pid 5678  fd 5: prog_id 42  kprobe  tcp_sendmsg  
```

**Informations :**
- **PID** du processus qui a attach√©
- **File descriptor** utilis√©
- **Type** d'√©v√©nement

---

## Cas d'usage pratiques de bpftool

### 1. Debugging : Pourquoi mon programme ne se charge pas ?

```bash
# Activer les logs verbeux du verifier
$ sudo bpftool prog load program.bpf.o /sys/fs/bpf/test \
    type tracepoint \
    --debug

# Sortie typique en cas d'erreur
libbpf: prog 'trace_execve': BPF program load failed: Permission denied  
libbpf: prog 'trace_execve': -- BEGIN PROG LOAD LOG --  
0: (85) call bpf_probe_read#4
invalid indirect read from stack R2 off -8+0 size 8  
processed 10 insns (limit 1000000)  
-- END PROG LOAD LOG --
```

**Le log du verifier indique exactement o√π et pourquoi le programme est rejet√©.**

### 2. Monitoring : Quels programmes eBPF tournent sur mon syst√®me ?

```bash
# Script de monitoring
$ watch -n 1 'sudo bpftool prog list | head -20'

# Ou avec statistiques
$ sudo bpftool prog show --json | \
    jq -r '.[] | "\(.name) - Run count: \(.run_cnt // 0)"'
```

### 3. Introspection : Comprendre ce que fait un outil eBPF

```bash
# Cilium est install√©, que fait-il exactement ?
$ sudo bpftool prog list | grep cilium

# Voir les maps utilis√©es
$ sudo bpftool map list | grep cilium

# Voir les links
$ sudo bpftool link list | head
```

### 4. Forensics : Analyser une attaque

```bash
# Un programme eBPF suspect est charg√© (ID 666)
$ sudo bpftool prog show id 666

# D'o√π vient-il ?
$ sudo ls -l /proc/$(pidof suspicious_process)/fd/ | grep bpf

# Dumper le bytecode pour analyse
$ sudo bpftool prog dump xlated id 666 > malicious_prog.dump

# V√©rifier les maps auxquelles il acc√®de
$ sudo bpftool prog show id 666 --json | jq '.map_ids'
```

### 5. Performance : Profiler un programme eBPF

```bash
# Compter les ex√©cutions
$ sudo bpftool prog show id 23 --json | jq '.run_cnt'
1234567

# Mesurer le temps d'ex√©cution
$ sudo bpftool prog show id 23 --json | jq '.run_time_ns'
987654321

# Calculer la latence moyenne
$ echo "scale=2; 987654321 / 1234567" | bc
799.99 ns par ex√©cution
```

### 6. D√©veloppement : Workflow avec bpftool

```bash
# 1. G√©n√©rer vmlinux.h
$ sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h

# 2. D√©velopper program.bpf.c

# 3. Compiler
$ clang -O2 -target bpf -g -c program.bpf.c -o program.bpf.o

# 4. Tester le chargement (sans attacher)
$ sudo bpftool prog load program.bpf.o /sys/fs/bpf/test

# 5. V√©rifier
$ sudo bpftool prog show pinned /sys/fs/bpf/test

# 6. G√©n√©rer le skeleton pour le code userspace
$ bpftool gen skeleton program.bpf.o > program.skel.h

# 7. Cleanup
$ sudo rm /sys/fs/bpf/test
```

---

## Options globales utiles

### Format JSON

```bash
# Sortie JSON pour parsing avec jq, python, etc.
$ sudo bpftool prog list --json --pretty
```

### Format de base64

```bash
# Utile pour transf√©rer du bytecode
$ sudo bpftool prog dump xlated id 23 --base64
```

### Debug verbeux

```bash
# Afficher plus d'informations (utile pour debugging)
$ sudo bpftool --debug prog load program.bpf.o /sys/fs/bpf/test
```

### Mode batch

```bash
# Ex√©cuter plusieurs commandes bpftool
$ cat commands.txt
prog list  
map list  
btf list  

$ sudo bpftool batch file commands.txt
```

---

## bpftool et s√©curit√©

### Permissions requises

bpftool n√©cessite g√©n√©ralement des **privil√®ges root** ou les capabilities suivantes :

```bash
# Capabilities requises (kernel 5.8+)
CAP_BPF  
CAP_PERFMON  
CAP_NET_ADMIN  # Pour les programmes r√©seau  
```

### Audit : Qui a charg√© quel programme ?

```bash
# Voir l'UID qui a charg√© chaque programme
$ sudo bpftool prog list | grep -E "^[0-9]+:" -A 1
23: tracepoint  name trace_execve
    loaded_at 2024-11-27T11:45:23+0000  uid 0

42: kprobe  name trace_tcp
    loaded_at 2024-11-27T12:00:01+0000  uid 1000
```

### Pr√©vention : Limiter l'acc√®s √† eBPF

```bash
# D√©sactiver eBPF pour les non-root (kernel 5.2+)
$ sudo sysctl -w kernel.unprivileged_bpf_disabled=1

# V√©rifier
$ sysctl kernel.unprivileged_bpf_disabled
kernel.unprivileged_bpf_disabled = 1
```

---

## Int√©gration avec d'autres outils

### bpftool + jq : Requ√™tes complexes

```bash
# Trouver tous les programmes de type tracepoint
$ sudo bpftool prog list --json | jq '.[] | select(.type == "tracepoint")'

# Compter les programmes par type
$ sudo bpftool prog list --json | jq 'group_by(.type) | map({type: .[0].type, count: length})'

# Trouver le programme qui utilise le plus de m√©moire
$ sudo bpftool prog list --json | jq 'max_by(.bytes_memlock)'
```

### bpftool + watch : Monitoring en temps r√©el

```bash
# Surveiller les changements de maps en temps r√©el
$ watch -n 1 'sudo bpftool map dump id 1'

# Surveiller l'ajout/suppression de programmes
$ watch -d -n 1 'sudo bpftool prog list'
```

### bpftool + systemd : Persistence

```bash
# Service systemd pour √©pingler un programme au boot
$ cat /etc/systemd/system/bpf-monitor.service
[Unit]
Description=BPF Monitoring Tool  
After=network.target  

[Service]
Type=simple  
ExecStart=/usr/local/bin/my-bpf-tool  
ExecStopPost=/usr/bin/rm -f /sys/fs/bpf/monitor/*  

[Install]
WantedBy=multi-user.target
```

---

## bpftool vs autres outils

### bpftool vs BCC tools

| Aspect | bpftool | BCC tools |
|--------|---------|-----------|
| **But** | Inspecter/g√©rer eBPF | Outils sp√©cialis√©s |
| **Usage** | CLI g√©n√©rique | Scripts Python |
| **Installation** | Inclus kernel | Package s√©par√© |
| **Niveau** | Bas niveau | Haut niveau |
| **Flexibilit√©** | Tr√®s flexible | Cas d'usage fixes |

**Compl√©mentarit√© :** bpftool pour inspecter, BCC pour utiliser.

### bpftool vs bpftrace

| Aspect | bpftool | bpftrace |
|--------|---------|----------|
| **But** | Gestion eBPF | Tracing dynamique |
| **Langage** | N/A | Langage de scripting |
| **Usage** | Inspection | One-liners de tracing |
| **Niveau** | Gestion | Analyse |

**Compl√©mentarit√© :** bpftool pour voir ce qui tourne, bpftrace pour tracer.

---

## Ressources et documentation

### Documentation officielle

- **bpftool man page** : `man bpftool` et `man bpftool-prog`, `man bpftool-map`, etc.
- **Kernel docs** : https://www.kernel.org/doc/html/latest/bpf/bpftool.html
- **GitHub** : https://github.com/torvalds/linux/tree/master/tools/bpf/bpftool

### Tutoriels

- **"Introduction to bpftool"** : https://qmonnet.github.io/whirl-offload/2021/09/23/bpftool-features-thread/
- **libbpf-bootstrap examples** : Utilisation de bpftool pour le d√©veloppement

### Cheat sheet

```bash
# Quick reference
bpftool prog list              # Lister programmes  
bpftool map list               # Lister maps  
bpftool link list              # Lister links  
bpftool btf list               # Lister BTF  

bpftool prog dump xlated id X  # Voir bytecode  
bpftool prog dump jited id X   # Voir code natif  
bpftool map dump id X          # Voir contenu map  

bpftool prog pin id X /path    # √âpingler  
bpftool prog load file.o /path # Charger  

bpftool gen skeleton file.o    # G√©n√©rer skeleton  
bpftool btf dump file vmlinux  # G√©n√©rer vmlinux.h  

bpftool feature                # V√©rifier support  
bpftool --json --pretty        # Format JSON  
```

---

## Conclusion

**bpftool** est l'outil indispensable pour tout ing√©nieur travaillant avec eBPF. C'est le "couteau suisse" qui permet de :

‚úÖ **Inspecter** tout ce qui concerne eBPF sur un syst√®me  
‚úÖ **Debugger** les probl√®mes de chargement et d'ex√©cution  
‚úÖ **G√©rer** les objets eBPF (load, attach, pin)  
‚úÖ **D√©velopper** avec g√©n√©ration de skeletons et vmlinux.h  
‚úÖ **Monitorer** les programmes en production  
‚úÖ **Auditer** l'utilisation d'eBPF pour la s√©curit√©

Que vous d√©veloppiez vos propres outils eBPF avec libbpf, que vous utilisiez des outils existants comme Cilium ou Falco, ou que vous d√©bugiez des probl√®mes de performance, **bpftool sera votre compagnon quotidien**.

La ma√Ætrise de bpftool, combin√©e avec libbpf (section 21.4.1), vous donne toutes les cl√©s pour travailler professionnellement avec eBPF.

Dans la section suivante (21.4.3), nous explorerons la **compilation et le chargement** de programmes eBPF plus en d√©tail, incluant le workflow complet de d√©veloppement et les optimisations.

---

**üí° √Ä retenir :**
- bpftool est l'outil CLI officiel pour g√©rer et inspecter eBPF
- Structure intuitive : `bpftool <object> <command>`
- Objets principaux : prog, map, link, btf, gen
- Essentiel pour le debugging (dump xlated/jited, verifier logs)
- G√©n√©ration de skeletons et vmlinux.h pour le d√©veloppement
- Format JSON pour l'automatisation
- Install√© avec linux-tools sur la plupart des distributions

---

‚è≠Ô∏è [Compilation et chargement](/21-introduction-ebpf/04.3-compilation-chargement.md)
