üîù Retour au [Sommaire](/SOMMAIRE.md)

# 5.7.5 Formatage dans le CI/CD

## Introduction

L'**int√©gration continue (CI)** et le **d√©ploiement continu (CD)** sont des pratiques essentielles du d√©veloppement moderne. La CI/CD consiste √† automatiser les tests, v√©rifications et d√©ploiements √† chaque modification du code.

**Pourquoi v√©rifier le formatage dans le CI/CD ?**

M√™me avec des pre-commit hooks locaux, le formatage peut ne pas √™tre respect√© si :
- ‚ùå Un d√©veloppeur contourne les hooks avec `--no-verify`
- ‚ùå Un d√©veloppeur oublie d'installer les hooks
- ‚ùå Les modifications viennent d'une interface web (GitHub, GitLab)
- ‚ùå Un merge cr√©e des conflits mal format√©s

**La solution : V√©rification automatique dans le CI/CD**

Chaque fois qu'un commit est pouss√© ou qu'une pull request est cr√©√©e, le CI/CD :
1. ‚úÖ V√©rifie automatiquement le formatage
2. ‚úÖ Bloque le merge si le code n'est pas format√©
3. ‚úÖ Fournit un rapport clair des erreurs
4. ‚úÖ Garantit que 100% du code est format√©

---

## Qu'est-ce que le CI/CD ?

### Concepts de base

**CI (Continuous Integration - Int√©gration Continue) :**
- Automatise les tests √† chaque commit/push
- V√©rifie que le code compile
- Ex√©cute les tests unitaires
- V√©rifie le style de code (linting, formatage)

**CD (Continuous Deployment/Delivery - D√©ploiement Continu) :**
- Automatise le d√©ploiement
- Met en production automatiquement
- Cr√©e des releases

**Pour clang-format, nous utilisons la CI** pour v√©rifier le formatage.

### Plateformes CI/CD populaires

| Plateforme | H√©bergement | Popularit√© | Gratuit |
|------------|-------------|------------|---------|
| **GitHub Actions** | GitHub | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Oui (limites) |
| **GitLab CI** | GitLab | ‚≠ê‚≠ê‚≠ê‚≠ê | Oui (limites) |
| **Travis CI** | Cloud/On-premise | ‚≠ê‚≠ê‚≠ê | Limit√© |
| **Jenkins** | Self-hosted | ‚≠ê‚≠ê‚≠ê‚≠ê | Oui |
| **CircleCI** | Cloud | ‚≠ê‚≠ê‚≠ê | Oui (limites) |
| **Azure Pipelines** | Azure | ‚≠ê‚≠ê‚≠ê | Oui (limites) |

Dans cette section, nous nous concentrerons principalement sur **GitHub Actions** (le plus populaire) et **GitLab CI**.

---

## GitHub Actions

### Pr√©sentation

GitHub Actions est le syst√®me CI/CD int√©gr√© √† GitHub. Il est :
- ‚úÖ Gratuit pour les d√©p√¥ts publics
- ‚úÖ 2000 minutes/mois gratuites pour les d√©p√¥ts priv√©s
- ‚úÖ Facile √† configurer
- ‚úÖ Bien int√©gr√© avec GitHub
- ‚úÖ Large √©cosyst√®me d'actions r√©utilisables

### Configuration de base

Les workflows GitHub Actions sont d√©finis dans des fichiers YAML dans `.github/workflows/`.

**Structure du projet :**

```
mon_projet/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ format-check.yml    ‚Üê Workflow de v√©rification
‚îú‚îÄ‚îÄ .clang-format
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ main.c
‚îî‚îÄ‚îÄ README.md
```

### Workflow simple : V√©rification du formatage

Cr√©ez `.github/workflows/format-check.yml` :

```yaml
name: Format Check

# D√©clencher sur push et pull request
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  format-check:
    runs-on: ubuntu-latest

    steps:
    # 1. R√©cup√©rer le code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Installer clang-format
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    # 3. V√©rifier le formatage
    - name: Check formatting
      run: |
        find . -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
```

**Explication :**
- `on:` : Quand d√©clencher le workflow (push sur main, pull requests)
- `runs-on: ubuntu-latest` : Utiliser Ubuntu comme environnement
- `steps:` : Liste des √©tapes √† ex√©cuter
- `--dry-run` : Ne modifie pas les fichiers, v√©rifie seulement
- `--Werror` : Traite les avertissements comme des erreurs

### Workflow avec rapport d√©taill√©

Pour un rapport plus clair, cr√©ez `.github/workflows/format-check.yml` :

```yaml
name: Code Formatting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  clang-format:
    name: Check C/C++ formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        clang-format --version

    - name: Run clang-format check
      run: |
        echo "üîç Checking code formatting..."

        # Trouver tous les fichiers C/C++
        FILES=$(find . -name "*.c" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp")

        # V√©rifier le formatage
        FAILED=0
        for file in $FILES; do
          if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
            echo "‚ùå $file is not properly formatted"
            FAILED=1
          else
            echo "‚úÖ $file"
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "üí° To fix formatting, run:"
          echo "   clang-format -i <file>"
          echo "   or"
          echo "   find . -name '*.c' -o -name '*.h' | xargs clang-format -i"
          exit 1
        fi

        echo ""
        echo "‚ú® All files are properly formatted!"
```

### Utiliser une action GitHub pr√™te √† l'emploi

Au lieu d'√©crire le script complet, utilisez une action existante :

```yaml
name: Format Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  formatting:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run clang-format style check
      uses: jidicula/clang-format-action@v4.11.0
      with:
        clang-format-version: '18'
        check-path: 'src'
        fallback-style: 'LLVM'
```

**Avantages :**
- ‚úÖ Plus simple
- ‚úÖ Maintenu par la communaut√©
- ‚úÖ Rapport format√© automatiquement

### Workflow complet avec plusieurs v√©rifications

```yaml
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format gcc make

    # V√©rification du formatage
    - name: Check code formatting
      run: |
        echo "üîç Checking formatting with clang-format..."
        find src -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror

    # Compilation
    - name: Build project
      run: |
        echo "üî® Building project..."
        make

    # Tests (si vous en avez)
    - name: Run tests
      run: |
        echo "üß™ Running tests..."
        make test

    - name: Success
      run: echo "‚úÖ All checks passed!"
```

### Badge de statut

Ajoutez un badge dans votre `README.md` pour afficher le statut :

```markdown
# Mon Projet

![Format Check](https://github.com/username/repo/workflows/Format%20Check/badge.svg)

Description du projet...
```

Le badge affichera ‚úÖ (vert) si le formatage est correct, ‚ùå (rouge) sinon.

---

## GitLab CI

### Pr√©sentation

GitLab CI est int√©gr√© √† GitLab et utilise des fichiers `.gitlab-ci.yml`.

**Avantages :**
- ‚úÖ Gratuit pour les d√©p√¥ts publics et priv√©s
- ‚úÖ Bien int√©gr√© avec GitLab
- ‚úÖ Runners partag√©s ou self-hosted

### Configuration de base

Cr√©ez `.gitlab-ci.yml` √† la racine du projet :

```yaml
# Configuration GitLab CI pour v√©rification du formatage

stages:
  - check

# Job de v√©rification du formatage
format-check:
  stage: check
  image: ubuntu:latest

  before_script:
    - apt-get update -qq
    - apt-get install -y clang-format

  script:
    - echo "üîç V√©rification du formatage..."
    - find . -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
    - echo "‚úÖ Formatage correct!"

  only:
    - merge_requests
    - main
    - develop
```

### Workflow avec rapport d√©taill√©

```yaml
stages:
  - quality
  - build
  - test

variables:
  CLANG_FORMAT_VERSION: "14"

# V√©rification du formatage
clang-format:
  stage: quality
  image: ubuntu:22.04

  before_script:
    - apt-get update
    - apt-get install -y clang-format-${CLANG_FORMAT_VERSION}
    - clang-format-${CLANG_FORMAT_VERSION} --version

  script:
    - |
      echo "üîç Checking code formatting..."
      FAILED=0

      for file in $(find src include -name "*.c" -o -name "*.h"); do
        if ! clang-format-${CLANG_FORMAT_VERSION} --dry-run --Werror "$file" 2>&1; then
          echo "‚ùå $file is not properly formatted"
          FAILED=1
        else
          echo "‚úÖ $file"
        fi
      done

      if [ $FAILED -eq 1 ]; then
        echo ""
        echo "üí° Pour corriger le formatage :"
        echo "   clang-format -i <file>"
        exit 1
      fi

      echo "‚ú® Tous les fichiers sont correctement format√©s!"

  only:
    - merge_requests
    - main

# Compilation
build:
  stage: build
  image: gcc:latest
  script:
    - make
  artifacts:
    paths:
      - build/

# Tests
test:
  stage: test
  image: gcc:latest
  script:
    - make test
  dependencies:
    - build
```

### Badge de statut

Ajoutez dans votre `README.md` :

```markdown
# Mon Projet

[![pipeline status](https://gitlab.com/username/project/badges/main/pipeline.svg)](https://gitlab.com/username/project/-/commits/main)

Description du projet...
```

---

## Documentation pour les contributeurs

Ajoutez dans `CONTRIBUTING.md` :

```markdown
## CI/CD et v√©rifications automatiques

### V√©rifications automatiques

Chaque push et pull request d√©clenche automatiquement :

1. ‚úÖ **V√©rification du formatage** avec clang-format
2. ‚úÖ **Compilation** du projet
3. ‚úÖ **Tests unitaires**

### Que faire si le CI √©choue ?

#### √âchec du formatage

Si le job "Code Formatting" √©choue :

```bash
# Formater tous les fichiers
find src include -name "*.c" -o -name "*.h" | xargs clang-format -i

# Commiter les changements
git add .  
git commit -m "style: Fix formatting"  
git push  
```

### √âviter les √©checs

Avant de pousser, installer les pre-commit hooks :

```bash
pip install pre-commit  
pre-commit install  
```
```

---

## R√©sum√©

### Configuration minimale (GitHub Actions)

**`.github/workflows/format-check.yml` :**

```yaml
name: Format Check

on: [push, pull_request]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: sudo apt-get install -y clang-format
    - run: find . -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
```

**C'est tout !** Le formatage est maintenant v√©rifi√© automatiquement.

### Points cl√©s

- ‚úÖ Le CI/CD garantit que le code est toujours format√©
- ‚úÖ Bloque les merges de code mal format√©
- ‚úÖ Compl√®te les pre-commit hooks locaux
- ‚úÖ Fournit un retour visuel (badges, commentaires)
- ‚úÖ GitHub Actions est le choix le plus simple pour GitHub
- ‚úÖ Configuration versionn√©e et partag√©e

### Workflow complet recommand√©

1. **Local :** Pre-commit hooks formatent automatiquement
2. **CI :** V√©rifie le formatage √† chaque push/PR
3. **Protection :** Branche prot√©g√©e, merge impossible si CI √©choue
4. **Feedback :** Badges et commentaires automatiques

Cette combinaison garantit un code **toujours format√©** √† 100% !

---

Vous avez maintenant termin√© la section compl√®te sur clang-format ! Avec une configuration compl√®te (IDE + hooks + CI/CD), vous avez maintenant un workflow de d√©veloppement moderne et professionnel.

‚è≠Ô∏è [Les Fonctions](/06-fonctions/README.md)
