üîù Retour au [Sommaire](/SOMMAIRE.md)

# 30.1.1 Structure du workflow GitHub Actions

## Introduction

GitHub Actions est un syst√®me d'int√©gration continue (CI) et de d√©ploiement continu (CD) int√©gr√© directement √† GitHub. Il permet d'automatiser la compilation, les tests et le d√©ploiement de votre code C √† chaque modification de votre d√©p√¥t.

Dans cette section, nous allons d√©couvrir comment structurer un fichier de workflow GitHub Actions pour un projet C.

---

## Qu'est-ce qu'un workflow ?

Un **workflow** est un processus automatis√© configurable compos√© d'un ou plusieurs **jobs** (t√¢ches). Chaque workflow est d√©fini par un fichier YAML situ√© dans le r√©pertoire `.github/workflows/` de votre projet.

**Concepts cl√©s :**

- **Workflow** : L'ensemble du processus automatis√©
- **Job** : Une unit√© d'ex√©cution qui contient plusieurs √©tapes
- **Step** : Une action individuelle (commande shell, action pr√©d√©finie, etc.)
- **Runner** : La machine virtuelle qui ex√©cute les jobs (Ubuntu, Windows, macOS)

---

## Emplacement du fichier workflow

Les workflows GitHub Actions doivent √™tre plac√©s dans le r√©pertoire suivant de votre projet :

```
votre-projet/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci.yml          # Votre fichier de workflow
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ include/
‚îú‚îÄ‚îÄ CMakeLists.txt
‚îî‚îÄ‚îÄ README.md
```

Le nom du fichier peut √™tre ce que vous voulez (par exemple `ci.yml`, `build.yml`, `main.yml`), mais il doit avoir l'extension `.yml` ou `.yaml`.

---

## Structure de base d'un workflow

Voici la structure minimale d'un workflow GitHub Actions pour un projet C :

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Compiler le projet
      run: |
        gcc -o hello hello.c

    - name: Ex√©cuter le programme
      run: ./hello
```

Analysons chaque section en d√©tail.

---

## D√©cortication de la structure

### 1. Le nom du workflow

```yaml
name: CI
```

Cette ligne d√©finit le nom de votre workflow tel qu'il appara√Ætra dans l'interface GitHub. Choisissez un nom descriptif comme "CI", "Build and Test", "Int√©gration Continue", etc.

---

### 2. Les d√©clencheurs (triggers)

```yaml
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
```

La section `on:` d√©finit **quand** le workflow doit s'ex√©cuter.

**Explications :**

- `push:` : Le workflow s'ex√©cute √† chaque push (envoi de code)
- `branches: [ main ]` : Seulement sur la branche `main`
- `pull_request:` : Le workflow s'ex√©cute aussi lors de la cr√©ation ou mise √† jour d'une pull request

**Autres d√©clencheurs possibles :**

```yaml
on:
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Tous les jours √† minuit
  workflow_dispatch:      # Permet de lancer manuellement
```

---

### 3. Les jobs

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
```

La section `jobs:` contient tous les jobs du workflow. Chaque job s'ex√©cute en parall√®le par d√©faut (sauf si vous sp√©cifiez des d√©pendances).

- `build:` : Le nom du job (vous pouvez le nommer comme vous voulez)
- `runs-on: ubuntu-latest` : Le syst√®me d'exploitation sur lequel le job s'ex√©cute

**Runners disponibles :**

- `ubuntu-latest` : Ubuntu (recommand√© pour le C)
- `ubuntu-22.04` : Ubuntu 22.04 sp√©cifique
- `windows-latest` : Windows
- `macos-latest` : macOS

---

### 4. Les steps (√©tapes)

```yaml
steps:
- uses: actions/checkout@v4

- name: Compiler le projet
  run: |
    gcc -o hello hello.c

- name: Ex√©cuter le programme
  run: ./hello
```

Chaque job contient une liste de **steps** qui s'ex√©cutent s√©quentiellement.

#### a) Checkout du code

```yaml
- uses: actions/checkout@v4
```

Cette √©tape utilise une **action pr√©d√©finie** de GitHub pour t√©l√©charger votre code source dans le runner. C'est **toujours la premi√®re √©tape** de vos workflows.

- `uses:` indique qu'on utilise une action existante
- `actions/checkout@v4` est l'action officielle de GitHub (version 4)

#### b) √âtapes avec commandes

```yaml
- name: Compiler le projet
  run: |
    gcc -o hello hello.c
```

- `name:` : Description de l'√©tape (optionnel mais recommand√©)
- `run:` : Commande(s) shell √† ex√©cuter
- `|` : Permet d'√©crire plusieurs commandes sur plusieurs lignes

---

## Exemple complet pour un projet C r√©aliste

Voici un workflow plus complet pour un projet C structur√© :

```yaml
name: CI - Compilation et Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build sur Ubuntu
    runs-on: ubuntu-latest

    steps:
    # √âtape 1 : R√©cup√©rer le code
    - name: Checkout du code source
      uses: actions/checkout@v4

    # √âtape 2 : Installer les d√©pendances
    - name: Installer les outils de compilation
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make cmake

    # √âtape 3 : Cr√©er le r√©pertoire de build
    - name: Cr√©er le dossier build
      run: mkdir build

    # √âtape 4 : Configurer avec CMake
    - name: Configurer le projet avec CMake
      run: |
        cd build
        cmake ..

    # √âtape 5 : Compiler
    - name: Compiler le projet
      run: |
        cd build
        make

    # √âtape 6 : Ex√©cuter les tests
    - name: Lancer les tests
      run: |
        cd build
        ./tests/mon_programme_test
```

---

## Structure avanc√©e : Plusieurs jobs

Vous pouvez d√©finir plusieurs jobs dans un m√™me workflow :

```yaml
name: CI Compl√®te

on: [push, pull_request]

jobs:
  build:
    name: Compilation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compiler
        run: gcc -o app main.c

  test:
    name: Tests unitaires
    runs-on: ubuntu-latest
    needs: build  # Ce job attend que 'build' se termine
    steps:
      - uses: actions/checkout@v4
      - name: Compiler et tester
        run: |
          gcc -o app main.c
          ./app --test
```

La directive `needs: build` cr√©e une **d√©pendance** : le job `test` ne d√©marre que si `build` r√©ussit.

---

## Les variables d'environnement

Vous pouvez d√©finir des variables pour √©viter les r√©p√©titions :

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CC: gcc
      CFLAGS: -Wall -Wextra -O2

    steps:
    - uses: actions/checkout@v4

    - name: Compiler
      run: $CC $CFLAGS -o app main.c
```

---

## Visualisation du workflow dans GitHub

Une fois votre fichier `.github/workflows/ci.yml` cr√©√© et pouss√© sur GitHub :

1. Allez dans l'onglet **Actions** de votre d√©p√¥t
2. Vous verrez votre workflow list√©
3. Chaque ex√©cution (run) appara√Ætra avec son statut : ‚úÖ succ√®s, ‚ùå √©chec, üü° en cours
4. Cliquez sur une ex√©cution pour voir les logs d√©taill√©s de chaque step

---

## R√©sum√© de la structure

```yaml
name: [Nom du workflow]

on: [D√©clencheurs]

jobs:
  [nom-du-job]:
    runs-on: [syst√®me d'exploitation]

    steps:
    - uses: [action pr√©d√©finie]

    - name: [Description]
      run: [commandes shell]
```

---

## Bonnes pratiques

1. **Nommez clairement vos steps** : Utilisez toujours `name:` pour documenter ce que fait chaque √©tape

2. **Utilisez des versions sp√©cifiques** : Pr√©f√©rez `actions/checkout@v4` √† `actions/checkout@latest` pour la stabilit√©

3. **Validez votre YAML** : Les erreurs de syntaxe YAML sont fr√©quentes. Utilisez un validateur en ligne si besoin

4. **Commencez simple** : Ne cr√©ez pas un workflow complexe d√®s le d√©but. Ajoutez des fonctionnalit√©s progressivement

5. **V√©rifiez les logs** : Quand un workflow √©choue, lisez attentivement les logs de chaque step pour identifier le probl√®me

---

## Prochaines √©tapes

Maintenant que vous comprenez la structure de base d'un workflow GitHub Actions, vous pouvez :

- Ajouter des **matrix builds** pour tester sur plusieurs versions de GCC
- Int√©grer des **sanitizers** (AddressSanitizer, UBSan)
- Configurer **Valgrind** pour d√©tecter les fuites m√©moire
- Mesurer la **couverture de code** avec gcov/lcov
- Publier des **artifacts** (binaires compil√©s)

Ces sujets seront abord√©s dans les sections suivantes du module.

---

## Ressources compl√©mentaires

- [Documentation officielle GitHub Actions](https://docs.github.com/en/actions)
- [Marketplace des actions GitHub](https://github.com/marketplace?type=actions)
- [Syntaxe YAML en 5 minutes](https://learnxinyminutes.com/docs/yaml/)

---

**üéØ Points cl√©s √† retenir :**

‚úÖ Un workflow est d√©fini dans `.github/workflows/*.yml`  
‚úÖ Structure de base : `name` ‚Üí `on` ‚Üí `jobs` ‚Üí `steps`  
‚úÖ Toujours commencer par `actions/checkout@v4`  
‚úÖ Les jobs s'ex√©cutent en parall√®le par d√©faut  
‚úÖ Utilisez `runs-on: ubuntu-latest` pour du C sous Linux  
‚úÖ Visualisez l'ex√©cution dans l'onglet Actions de GitHub

‚è≠Ô∏è [Matrix build](/30-integration-continue/01.2-matrix-build.md)
